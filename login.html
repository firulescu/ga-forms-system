<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Robert Quinn Ltd ‚Äî GA Forms Login</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="js/data.js"></script>
<script src="js/auth.js"></script>
<style>
  :root {
    --bg: #060A14;
    --surface: #0D1421;
    --surface2: #111827;
    --border: #1A2333;
    --border2: #243044;
    --text: #E8EDF5;
    --muted: #6B7A99;
    --accent: #2E7D52;
    --danger: #FF4757;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    padding: 20px; overflow: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 0;
    background-image:
      linear-gradient(rgba(46,125,82,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(46,125,82,0.04) 1px, transparent 1px);
    background-size: 50px 50px;
    animation: gridMove 15s linear infinite;
    pointer-events: none;
  }
  @keyframes gridMove { from { background-position: 0 0; } to { background-position: 50px 50px; } }

  /* Glow orbs */
  body::after {
    content: '';
    position: fixed;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(46,125,82,0.06) 0%, transparent 70%);
    top: -100px; left: -100px;
    pointer-events: none; z-index: 0;
  }

  .login-wrap {
    position: relative; z-index: 1;
    width: 100%; max-width: 420px;
  }

  /* Brand */
  .brand {
    text-align: center; margin-bottom: 40px;
  }
  .brand-logo {
    width: 80px; height: 80px; border-radius: 50%;
    background: #1B5E35;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 16px;
    box-shadow: 0 0 0 8px rgba(27,94,53,0.15), 0 0 40px rgba(27,94,53,0.3);
    animation: float 3s ease-in-out infinite;
  }
  .logo-q {
    font-family: Georgia, serif;
    font-size: 48px; font-weight: 700; color: white;
    line-height: 1; padding-bottom: 4px;
  }
  @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-6px);} }
  .brand-name {
    font-family: 'Space Mono', monospace;
    font-size: 16px; font-weight: 700;
    color: var(--accent); letter-spacing: 3px;
  }
  .brand-sub { font-size: 10px; color: var(--muted); letter-spacing: 2px; margin-top: 6px; font-family: 'Space Mono', monospace; }

  /* Card */
  .login-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.4), 0 0 0 1px rgba(27,94,53,0.1);
  }

  /* Step labels */
  .step-label {
    font-size: 11px; color: var(--muted); letter-spacing: 3px;
    font-family: 'Space Mono', monospace; margin-bottom: 20px;
    display: flex; align-items: center; gap: 8px;
  }
  .step-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* Role grid */
  .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; }
  .role-btn {
    background: var(--surface2); border: 2px solid var(--border);
    border-radius: 14px; padding: 16px 12px; cursor: pointer;
    transition: all 0.2s; text-align: center;
    display: flex; flex-direction: column; align-items: center; gap: 6px;
  }
  .role-btn:hover { border-color: var(--border2); transform: translateY(-2px); }
  .role-btn.selected { transform: translateY(-2px); }
  .role-icon { font-size: 26px; }
  .role-name { font-size: 12px; font-weight: 700; font-family: 'Space Mono', monospace; letter-spacing: 0.5px; }
  .role-level { font-size: 10px; color: var(--muted); }

  /* PIN input */
  .pin-section { display: none; }
  .pin-section.visible { display: block; }
  .pin-label { font-size: 13px; color: var(--muted); margin-bottom: 16px; text-align: center; }
  .pin-label strong { color: var(--text); }

  /* PIN dots */
  .pin-display {
    display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;
  }
  .pin-dot {
    width: 16px; height: 16px; border-radius: 50%;
    border: 2px solid var(--border2);
    transition: all 0.15s;
  }
  .pin-dot.filled { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 8px rgba(46,125,82,0.5); }
  .pin-dot.error { background: var(--danger); border-color: var(--danger); }

  /* Numpad */
  .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .num-btn {
    background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 12px; padding: 18px; font-size: 20px; font-weight: 700;
    font-family: 'Space Mono', monospace; color: var(--text);
    cursor: pointer; transition: all 0.15s; text-align: center;
    -webkit-tap-highlight-color: transparent; user-select: none;
  }
  .num-btn:hover { background: var(--border); border-color: var(--border2); }
  .num-btn:active { transform: scale(0.95); background: var(--border2); }
  .num-btn.del { font-size: 18px; color: var(--muted); }
  .num-btn.enter { background: var(--accent); color: #060A14; border-color: var(--accent); font-size: 14px; letter-spacing: 1px; }
  .num-btn.enter:hover { background: #3a9e68; }
  .num-btn.enter:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Name input */
  .name-section { margin-bottom: 20px; }
  .form-label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 6px; letter-spacing: 2px; font-family: 'Space Mono', monospace; }
  .form-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 10px; padding: 12px 14px; color: var(--text);
    font-family: 'Syne', sans-serif; font-size: 15px;
    transition: border-color 0.2s;
  }
  .form-input:focus { outline: none; border-color: var(--accent); }

  /* Error message */
  .error-msg {
    background: rgba(255,71,87,0.1); border: 1px solid rgba(255,71,87,0.3);
    border-radius: 8px; padding: 10px 14px;
    font-size: 13px; color: var(--danger);
    margin-bottom: 16px; text-align: center;
    display: none;
  }
  .error-msg.visible { display: block; animation: shake 0.3s ease; }
  @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-6px);} 75%{transform:translateX(6px);} }

  /* Back link */
  .back-link {
    text-align: center; margin-top: 16px;
    font-size: 12px; color: var(--muted); cursor: pointer;
    font-family: 'Space Mono', monospace;
  }
  .back-link:hover { color: var(--text); }

  /* Copyright footer */
  .copyright {
    text-align: center; margin-top: 24px;
    font-size: 10px; color: var(--muted);
    font-family: 'Space Mono', monospace; line-height: 1.6;
  }

  /* Default PIN notice */
  .pin-notice {
    background: rgba(255,183,0,0.08); border: 1px solid rgba(255,183,0,0.2);
    border-radius: 8px; padding: 10px 14px; font-size: 11px;
    color: #FFB800; margin-top: 16px; font-family: 'Space Mono', monospace;
    line-height: 1.6;
  }
</style>
</head>
<body>
<div class="login-wrap">
  <div class="brand">
    <div class="brand-logo">
      <div class="logo-q">Q</div>
    </div>
    <div class="brand-name">ROBERT QUINN LTD</div>
    <div class="brand-sub">GA FORMS ¬∑ SAFETY MANAGEMENT SYSTEM</div>
  </div>

  <div class="login-card">

    <!-- STEP 1: Select Role -->
    <div id="step-role">
      <div class="step-label">SELECT YOUR ROLE</div>
      <div class="role-grid" id="role-grid"></div>
      <div class="pin-notice" id="default-pin-notice">
        ‚ö†Ô∏è Default PINs are active.<br>
        Admin: 0000 ¬∑ Manager: 1111<br>
        Safety: 2222 ¬∑ Operator: 3333<br>
        Change them after first login in Settings.
      </div>
    </div>

    <!-- STEP 2: Enter Name + PIN -->
    <div id="step-pin" style="display:none;">
      <div class="step-label" id="pin-step-label">ENTER PIN</div>

      <div class="name-section">
        <label class="form-label">YOUR NAME</label>
        <input type="text" class="form-input" id="login-name" placeholder="First and last name" autocomplete="name">
      </div>

      <div class="pin-label">Enter PIN for <strong id="selected-role-label">Role</strong></div>

      <div class="pin-display" id="pin-display">
        <div class="pin-dot" id="dot-0"></div>
        <div class="pin-dot" id="dot-1"></div>
        <div class="pin-dot" id="dot-2"></div>
        <div class="pin-dot" id="dot-3"></div>
      </div>

      <div class="error-msg" id="error-msg">Incorrect PIN. Please try again.</div>

      <div class="numpad">
        <button class="num-btn" onclick="addDigit('1')">1</button>
        <button class="num-btn" onclick="addDigit('2')">2</button>
        <button class="num-btn" onclick="addDigit('3')">3</button>
        <button class="num-btn" onclick="addDigit('4')">4</button>
        <button class="num-btn" onclick="addDigit('5')">5</button>
        <button class="num-btn" onclick="addDigit('6')">6</button>
        <button class="num-btn" onclick="addDigit('7')">7</button>
        <button class="num-btn" onclick="addDigit('8')">8</button>
        <button class="num-btn" onclick="addDigit('9')">9</button>
        <button class="num-btn del" onclick="delDigit()">‚å´</button>
        <button class="num-btn" onclick="addDigit('0')">0</button>
        <button class="num-btn enter" id="enter-btn" onclick="submitPin()">LOGIN</button>
      </div>

      <div class="back-link" onclick="goBack()">‚Üê Change role</div>
    </div>

  </div>

  <div class="copyright">
    ¬© 2026 Robert Quinn Ltd ¬∑ All rights reserved<br>
    GA Forms Safety System ¬∑ firulescum@gmail.com
  </div>
</div>

<script>
// ============================================================
// State
// ============================================================
let selectedRole = null;
let pin = '';
const MAX_PIN = 6; // support up to 6 digit PINs

const roleColors = {
  admin: '#C9A84C',
  site_manager: '#2E7D52',
  safety_officer: '#3a9e68',
  operator: '#6B7A99',
};

// ============================================================
// Render roles
// ============================================================
function renderRoles() {
  const grid = document.getElementById('role-grid');
  const roles = [
    { key: 'admin',          icon: 'üëë', name: 'Admin',          level: 'Full Access' },
    { key: 'site_manager',   icon: 'üèóÔ∏è', name: 'Site Manager',   level: 'Management' },
    { key: 'safety_officer', icon: 'üõ°Ô∏è', name: 'Safety Officer', level: 'Safety' },
    { key: 'operator',       icon: 'üë∑', name: 'Operator',       level: 'Field' },
  ];
  grid.innerHTML = roles.map(r => `
    <div class="role-btn" id="role-${r.key}" onclick="selectRole('${r.key}')"
         style="border-color:${selectedRole===r.key ? roleColors[r.key] : 'var(--border)'};">
      <span class="role-icon">${r.icon}</span>
      <span class="role-name" style="color:${roleColors[r.key]};">${r.name}</span>
      <span class="role-level">${r.level}</span>
    </div>`).join('');

  // Hide default PIN notice if PINs have been changed
  const pins = AUTH.getPins();
  const defaults = AUTH.DEFAULT_PINS;
  const usingDefaults = Object.keys(defaults).every(k => pins[k] === defaults[k]);
  document.getElementById('default-pin-notice').style.display = usingDefaults ? '' : 'none';
}

function selectRole(role) {
  selectedRole = role;
  pin = '';
  document.getElementById('step-role').style.display = 'none';
  document.getElementById('step-pin').style.display = '';
  document.getElementById('selected-role-label').textContent = AUTH.ROLES[role].label;
  document.getElementById('login-name').focus();
  updateDots();
  clearError();
}

function goBack() {
  selectedRole = null;
  pin = '';
  document.getElementById('step-role').style.display = '';
  document.getElementById('step-pin').style.display = 'none';
  renderRoles();
}

// ============================================================
// PIN input
// ============================================================
function addDigit(d) {
  if (pin.length >= MAX_PIN) return;
  pin += d;
  updateDots();
  clearError();
  if (pin.length >= 4) {
    // Auto-submit after short delay if we have 4+ digits and no more input
    // (user can always press LOGIN manually)
  }
}

function delDigit() {
  pin = pin.slice(0, -1);
  updateDots();
  clearError();
}

function updateDots() {
  const display = document.getElementById('pin-display');
  // Render dynamic dots based on pin length
  const maxDots = Math.max(4, pin.length);
  display.innerHTML = Array.from({ length: maxDots }, (_, i) =>
    `<div class="pin-dot ${i < pin.length ? 'filled' : ''}"></div>`
  ).join('');
}

function clearError() {
  document.getElementById('error-msg').classList.remove('visible');
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.classList.add('visible');
  // Flash dots red
  document.querySelectorAll('.pin-dot').forEach(d => {
    d.classList.add('error');
    setTimeout(() => d.classList.remove('error'), 600);
  });
  pin = '';
  setTimeout(() => updateDots(), 100);
}

// ============================================================
// Submit
// ============================================================
function submitPin() {
  const name = document.getElementById('login-name').value.trim();
  if (!name) {
    document.getElementById('login-name').focus();
    document.getElementById('login-name').style.borderColor = 'var(--danger)';
    setTimeout(() => document.getElementById('login-name').style.borderColor = '', 1500);
    return;
  }
  if (pin.length < 4) {
    showError('PIN must be at least 4 digits');
    return;
  }
  if (!AUTH.verifyPin(selectedRole, pin)) {
    showError('Incorrect PIN. Please try again.');
    return;
  }

  // Success
  AUTH.setSession(selectedRole, name);
  DB.addNotification({
    title: `üîê Login ‚Äî ${AUTH.ROLES[selectedRole].label}`,
    message: `${name} logged in as ${AUTH.ROLES[selectedRole].label}`,
    type: 'info'
  });

  // Redirect based on role ‚Äî honour ?return= param if present
  const returnUrl = params.get('return');
  if (returnUrl) {
    window.location.href = decodeURIComponent(returnUrl);
  } else if (selectedRole === 'operator') {
    window.location.href = 'form.html';
  } else {
    window.location.href = 'index.html';
  }
}

// ============================================================
// Keyboard support
// ============================================================
document.addEventListener('keydown', e => {
  if (document.getElementById('step-pin').style.display === 'none') return;
  if (e.key >= '0' && e.key <= '9') addDigit(e.key);
  if (e.key === 'Backspace') delDigit();
  if (e.key === 'Enter') submitPin();
});

// ============================================================
// Init
// ============================================================
// params must be top-level so submitPin() can access it
const params = new URLSearchParams(window.location.search);

document.addEventListener('DOMContentLoaded', () => {
  DB.getPlants();
  DB.getFormTemplates();

  // If already logged in, redirect
  if (AUTH.isLoggedIn()) {
    const role = AUTH.getRole();
    if (role === 'operator') window.location.href = 'form.html';
    else window.location.href = 'index.html';
    return;
  }

  // If coming from a QR code scan (?plant= in the return URL), skip role
  // selection and go straight to Operator PIN ‚Äî only operators scan QR codes
  const returnUrl = params.get('return') || '';
  const isQRScan  = returnUrl.includes('plant=') || window.location.search.includes('plant=');
  if (isQRScan) {
    selectRole('operator');
  } else {
    renderRoles();
  }
});
</script>
</body>
</html>
