<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Robert Quinn Ltd ‚Äî GA Forms</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="js/data.js"></script>
<script src="js/auth.js"></script>
<style>
  :root { --bg:#060A14; --surface:#0D1421; --surface2:#111827; --border:#1A2333; --border2:#243044; --text:#E8EDF5; --muted:#6B7A99; --accent:#2E7D52; --danger:#FF4757; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
  body::before { content:''; position:fixed; inset:0; z-index:0;
    background-image: linear-gradient(rgba(46,125,82,0.04) 1px,transparent 1px), linear-gradient(90deg,rgba(46,125,82,0.04) 1px,transparent 1px);
    background-size:50px 50px; animation:gridMove 15s linear infinite; pointer-events:none; }
  @keyframes gridMove { from{background-position:0 0} to{background-position:50px 50px} }

  .wrap { position:relative; z-index:1; width:100%; max-width:420px; }

  /* BRAND */
  .brand { text-align:center; margin-bottom:28px; }
  .brand-logo { width:68px; height:68px; border-radius:50%; background:#1B5E35;
    display:flex; align-items:center; justify-content:center; margin:0 auto 12px;
    box-shadow:0 0 0 8px rgba(27,94,53,0.12), 0 0 40px rgba(27,94,53,0.25);
    animation:float 3s ease-in-out infinite; }
  .logo-q { font-family:Georgia,serif; font-size:38px; font-weight:700; color:white; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
  .brand-name { font-family:'Space Mono',monospace; font-size:13px; font-weight:700; color:var(--accent); letter-spacing:3px; }
  .brand-sub  { font-size:10px; color:var(--muted); letter-spacing:2px; margin-top:3px; font-family:'Space Mono',monospace; }

  /* CARD */
  .card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:26px; box-shadow:0 24px 80px rgba(0,0,0,0.4); }

  /* STEP LABEL */
  .step-lbl { font-size:10px; color:var(--muted); letter-spacing:3px; font-family:'Space Mono',monospace; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
  .step-lbl::after { content:''; flex:1; height:1px; background:var(--border); }

  /* SITE PICKER ‚Äî compact for 4-10 sites */
  .site-search { width:100%; background:var(--surface2); border:1px solid var(--border2); border-radius:10px; color:var(--text); font-family:'Syne',sans-serif; font-size:14px; padding:10px 14px; margin-bottom:12px; outline:none; }
  .site-search:focus { border-color:var(--accent); }
  .site-list { display:flex; flex-direction:column; gap:8px; max-height:260px; overflow-y:auto; }
  .site-btn { background:var(--surface2); border:1px solid var(--border2); border-radius:10px; padding:12px 14px; cursor:pointer; transition:all 0.15s; text-align:left; display:flex; align-items:center; gap:12px; }
  .site-btn:hover, .site-btn:focus { border-color:var(--accent); background:rgba(46,125,82,0.06); outline:none; }
  .site-icon { width:36px; height:36px; border-radius:8px; background:#1B5E35; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
  .site-name { font-size:13px; font-weight:700; }
  .site-meta { font-size:11px; color:var(--muted); margin-top:2px; font-family:'Space Mono',monospace; }

  /* SELECTED SITE CHIP */
  .site-chip { display:flex; align-items:center; gap:10px; background:rgba(46,125,82,0.08); border:1px solid rgba(46,125,82,0.25); border-radius:10px; padding:9px 13px; margin-bottom:16px; }
  .site-chip-name { font-size:13px; font-weight:700; color:var(--accent); flex:1; }
  .site-chip-change { font-size:11px; color:var(--muted); cursor:pointer; font-family:'Space Mono',monospace; padding:3px 8px; border:1px solid var(--border2); border-radius:6px; white-space:nowrap; }
  .site-chip-change:hover { border-color:var(--accent); color:var(--text); }

  /* NAME INPUT ‚Äî big and tap-friendly */
  .name-input { width:100%; background:var(--surface2); border:2px solid var(--border2); border-radius:12px; color:var(--text); font-family:'Syne',sans-serif; font-size:18px; font-weight:600; padding:16px 18px; outline:none; transition:border-color 0.2s; margin-bottom:6px; }
  .name-input:focus { border-color:var(--accent); }
  .name-input::placeholder { color:var(--muted); font-weight:400; font-size:15px; }

  /* NAME SUGGESTIONS */
  .suggestions { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; min-height:0; }
  .suggest-btn { background:var(--surface2); border:1px solid var(--border2); border-radius:9px; padding:10px 14px; cursor:pointer; transition:all 0.15s; text-align:left; display:flex; align-items:center; gap:10px; }
  .suggest-btn:hover { border-color:var(--accent); background:rgba(46,125,82,0.06); }
  .suggest-name { font-size:13px; font-weight:700; }
  .suggest-role { font-size:11px; font-family:'Space Mono',monospace; margin-top:1px; }
  .suggest-empty { font-size:12px; color:var(--muted); text-align:center; padding:12px; font-family:'Space Mono',monospace; }

  /* SELECTED USER CHIP */
  .user-chip { display:flex; align-items:center; gap:10px; background:rgba(46,125,82,0.08); border:1px solid rgba(46,125,82,0.25); border-radius:12px; padding:12px 14px; margin-bottom:16px; animation:fadeIn 0.2s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }
  .user-chip-icon { font-size:24px; }
  .user-chip-name { font-size:15px; font-weight:700; }
  .user-chip-role { font-size:11px; font-family:'Space Mono',monospace; margin-top:2px; }
  .user-chip-change { font-size:11px; color:var(--muted); cursor:pointer; font-family:'Space Mono',monospace; padding:3px 8px; border:1px solid var(--border2); border-radius:6px; margin-left:auto; white-space:nowrap; flex-shrink:0; }
  .user-chip-change:hover { border-color:var(--danger); color:var(--danger); }

  /* PIN DOTS */
  .pin-row { display:flex; gap:10px; justify-content:center; margin:14px 0; }
  .dot { width:14px; height:14px; border-radius:50%; border:2px solid var(--border2); transition:all 0.15s; }
  .dot.filled { background:var(--accent); border-color:var(--accent); box-shadow:0 0 8px rgba(46,125,82,0.5); }
  .dot.error  { background:var(--danger); border-color:var(--danger); animation:shake 0.35s; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

  /* NUMPAD */
  .numpad { display:grid; grid-template-columns:repeat(3,1fr); gap:9px; }
  .num-btn { background:var(--surface2); border:1px solid var(--border2); color:var(--text); font-family:'Space Mono',monospace; font-size:20px; font-weight:700; height:58px; border-radius:11px; cursor:pointer; transition:all 0.1s; user-select:none; -webkit-tap-highlight-color:transparent; display:flex; align-items:center; justify-content:center; }
  .num-btn:active { transform:scale(0.91); background:var(--border2); }
  .num-btn.del { font-size:16px; color:var(--muted); }
  .num-btn.go  { background:var(--accent); color:white; border-color:var(--accent); font-size:13px; font-weight:700; letter-spacing:1px; }
  .num-btn.go:hover { background:#3a9e68; }
  .num-btn.go:disabled { background:var(--surface2); color:var(--muted); border-color:var(--border2); cursor:not-allowed; }

  /* ERROR */
  .err { font-size:12px; color:var(--danger); text-align:center; min-height:16px; font-family:'Space Mono',monospace; margin:8px 0 4px; }

  /* BACK / PROGRESS */
  .back-link { text-align:center; font-size:12px; color:var(--muted); margin-top:14px; cursor:pointer; font-family:'Space Mono',monospace; }
  .back-link:hover { color:var(--text); }
  .progress-dots { display:flex; gap:6px; justify-content:center; margin-bottom:20px; }
  .prog-dot { width:6px; height:6px; border-radius:50%; background:var(--border2); transition:background 0.2s; }
  .prog-dot.active { background:var(--accent); }

  .copyright { text-align:center; margin-top:18px; font-size:10px; color:var(--muted); font-family:'Space Mono',monospace; }
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <div class="brand-logo"><div class="logo-q">Q</div></div>
    <div class="brand-name">ROBERT QUINN LTD</div>
    <div class="brand-sub">GA FORMS ¬∑ SAFETY MANAGEMENT</div>
  </div>

  <div class="card">
    <!-- Progress indicator -->
    <div class="progress-dots">
      <div class="prog-dot active" id="prog-0"></div>
      <div class="prog-dot" id="prog-1"></div>
      <div class="prog-dot" id="prog-2"></div>
    </div>

    <!-- STEP 1: SITE -->
    <div id="step-site">
      <div class="step-lbl">SELECT SITE</div>
      <input class="site-search" id="site-search" type="text" placeholder="üîç  Search sites..." oninput="filterSites(this.value)" autocomplete="off">
      <div class="site-list" id="site-list"></div>
    </div>

    <!-- STEP 2: NAME -->
    <div id="step-name" style="display:none;">
      <div id="site-chip-name"></div>
      <div class="step-lbl">YOUR NAME</div>
      <input class="name-input" id="name-input" type="text" placeholder="Start typing your name..." autocomplete="off" oninput="filterNames(this.value)" autocorrect="off">
      <div class="suggestions" id="suggestions"></div>
      <div class="back-link" onclick="goToStep(1)">‚Üê Back to sites</div>
    </div>

    <!-- STEP 3: PIN -->
    <div id="step-pin" style="display:none;">
      <div id="site-chip-pin"></div>
      <div id="user-chip"></div>
      <div class="step-lbl">ENTER YOUR PIN</div>
      <div class="pin-row" id="pin-dots">
        <div class="dot" id="d0"></div><div class="dot" id="d1"></div>
        <div class="dot" id="d2"></div><div class="dot" id="d3"></div>
        <div class="dot" id="d4" style="display:none;"></div>
        <div class="dot" id="d5" style="display:none;"></div>
      </div>
      <div class="err" id="err-msg"></div>
      <div class="numpad">
        <button class="num-btn" onclick="digit('1')">1</button>
        <button class="num-btn" onclick="digit('2')">2</button>
        <button class="num-btn" onclick="digit('3')">3</button>
        <button class="num-btn" onclick="digit('4')">4</button>
        <button class="num-btn" onclick="digit('5')">5</button>
        <button class="num-btn" onclick="digit('6')">6</button>
        <button class="num-btn" onclick="digit('7')">7</button>
        <button class="num-btn" onclick="digit('8')">8</button>
        <button class="num-btn" onclick="digit('9')">9</button>
        <button class="num-btn del" onclick="delDigit()">‚å´</button>
        <button class="num-btn" onclick="digit('0')">0</button>
        <button class="num-btn go" id="btn-go" onclick="tryLogin()" disabled>GO</button>
      </div>
      <div class="back-link" onclick="goToStep(2)">‚Üê Back to name</div>
    </div>
  </div>

  <div class="copyright">¬© 2026 Robert Quinn Ltd ¬∑ All rights reserved</div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
let selectedSite = null;
let selectedUser = null;
let pin = '';
let step = 1;

// ‚îÄ‚îÄ STEP MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goToStep(n) {
  step = n;
  document.getElementById('step-site').style.display = n === 1 ? '' : 'none';
  document.getElementById('step-name').style.display = n === 2 ? '' : 'none';
  document.getElementById('step-pin').style.display  = n === 3 ? '' : 'none';
  for (let i = 0; i < 3; i++) {
    document.getElementById('prog-' + i).className = 'prog-dot' + (i < n ? ' active' : '');
  }
  if (n === 1) { selectedSite = null; selectedUser = null; pin = ''; }
  if (n === 2) {
    selectedUser = null; pin = '';
    document.getElementById('name-input').value = '';
    document.getElementById('suggestions').innerHTML = '';
    setTimeout(() => document.getElementById('name-input').focus(), 150);
    renderSiteChip('site-chip-name');
  }
  if (n === 3) {
    pin = ''; updateDots(); clearErr();
    renderSiteChip('site-chip-pin');
    renderUserChip();
    const pinLen = selectedUser?.pin?.length || 4;
    for (let i = 0; i < 6; i++) {
      const d = document.getElementById('d' + i);
      if (d) d.style.display = i < pinLen ? '' : 'none';
    }
  }
}

function renderSiteChip(id) {
  if (!selectedSite) return;
  document.getElementById(id).innerHTML = `
    <div class="site-chip">
      <span style="font-size:18px;">üèóÔ∏è</span>
      <span class="site-chip-name">${selectedSite.name}</span>
      <span class="site-chip-change" onclick="goToStep(1)">change</span>
    </div>`;
}

function renderUserChip() {
  if (!selectedUser) return;
  const ri = AUTH.ROLES[selectedUser.role] || { icon:'üë§', color:'#888', label: selectedUser.role };
  document.getElementById('user-chip').innerHTML = `
    <div class="user-chip">
      <span class="user-chip-icon">${ri.icon}</span>
      <div>
        <div class="user-chip-name">${selectedUser.name}</div>
        <div class="user-chip-role" style="color:${ri.color};">${ri.label}</div>
      </div>
      <span class="user-chip-change" onclick="goToStep(2)">not me</span>
    </div>`;
}

// ‚îÄ‚îÄ STEP 1: SITES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSites(filter) {
  let sites = AUTH.getSites().filter(s => s.active !== false);
  if (filter) sites = sites.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()) || (s.address||'').toLowerCase().includes(filter.toLowerCase()));
  const list = document.getElementById('site-list');
  if (!sites.length) {
    list.innerHTML = '<div class="suggest-empty">No sites match your search</div>';
    return;
  }
  list.innerHTML = sites.map((s, i) => {
    const userCount = AUTH.getUsersForSite(s.id).filter(u => u.active !== false).length;
    const icons = ['üèóÔ∏è','üî®','‚öíÔ∏è','üèöÔ∏è','üß±','üî©','ü™õ','ü¶∫'];
    return `<button class="site-btn" onclick="selectSite('${s.id}')" tabindex="${i+1}">
      <div class="site-icon">${icons[i % icons.length]}</div>
      <div>
        <div class="site-name">${s.name}</div>
        <div class="site-meta">üìç ${s.address||'No address'} ¬∑ ${userCount} user${userCount!==1?'s':''}</div>
      </div>
    </button>`;
  }).join('');
}

function filterSites(val) { renderSites(val); }

function selectSite(id) {
  selectedSite = AUTH.getSite(id);
  goToStep(2);
  // Show all names initially
  filterNames('');
}

// ‚îÄ‚îÄ STEP 2: NAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterNames(val) {
  const users = AUTH.getUsersForSite(selectedSite.id).filter(u => u.active !== false);
  const q = val.trim().toLowerCase();
  const filtered = q ? users.filter(u => u.name.toLowerCase().includes(q)) : users;
  const wrap = document.getElementById('suggestions');
  if (!filtered.length) {
    wrap.innerHTML = `<div class="suggest-empty">No users found${q ? ' matching "' + val + '"' : ''}</div>`;
    return;
  }
  wrap.innerHTML = filtered.slice(0, 8).map(u => {
    const ri = AUTH.ROLES[u.role] || { icon:'üë§', color:'#888', label: u.role };
    return `<button class="suggest-btn" onclick="selectUser('${u.id}')">
      <span style="font-size:20px;">${ri.icon}</span>
      <div>
        <div class="suggest-name">${highlightMatch(u.name, q)}</div>
        <div class="suggest-role" style="color:${ri.color};">${ri.label}</div>
      </div>
    </button>`;
  }).join('');
}

function highlightMatch(name, q) {
  if (!q) return name;
  const idx = name.toLowerCase().indexOf(q);
  if (idx < 0) return name;
  return name.slice(0, idx) + '<strong style="color:var(--accent);">' + name.slice(idx, idx + q.length) + '</strong>' + name.slice(idx + q.length);
}

function selectUser(id) {
  selectedUser = AUTH.getUser(id);
  goToStep(3);
}

// Handle keyboard Enter on name input to select first match
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('name-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const first = document.querySelector('.suggest-btn');
      if (first) first.click();
    }
  });
});

// ‚îÄ‚îÄ STEP 3: PIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function digit(d) {
  const maxLen = selectedUser?.pin?.length || 4;
  if (pin.length >= maxLen) return;
  pin += d;
  updateDots();
  clearErr();
  document.getElementById('btn-go').disabled = pin.length < 4;
  if (pin.length === maxLen) {
    setTimeout(tryLogin, 150);
  }
}

function delDigit() {
  pin = pin.slice(0, -1);
  updateDots();
  clearErr();
  document.getElementById('btn-go').disabled = pin.length < 4;
}

function updateDots() {
  const len = selectedUser?.pin?.length || 4;
  for (let i = 0; i < len; i++) {
    const d = document.getElementById('d' + i);
    if (d) d.className = 'dot' + (i < pin.length ? ' filled' : '');
  }
}

function clearErr() { document.getElementById('err-msg').textContent = ''; }

function showErr(msg) {
  document.getElementById('err-msg').textContent = msg;
  for (let i = 0; i < 6; i++) {
    const d = document.getElementById('d' + i);
    if (d && d.style.display !== 'none') {
      d.classList.add('error');
      setTimeout(() => d.classList.remove('error'), 500);
    }
  }
  pin = '';
  setTimeout(updateDots, 50);
  document.getElementById('btn-go').disabled = true;
}

function tryLogin() {
  if (!selectedUser || !selectedSite) return;
  if (pin !== selectedUser.pin) {
    showErr('Incorrect PIN ‚Äî try again');
    return;
  }
  AUTH.setSession(selectedUser, selectedSite.id);
  const ret = params.get('return');
  if (ret) { window.location.href = decodeURIComponent(ret); return; }
  if (selectedUser.role === 'operator') { window.location.href = 'form.html'; return; }
  window.location.href = 'index.html';
}

// Keyboard support on PIN step
document.addEventListener('keydown', e => {
  if (step !== 3) return;
  if (e.key >= '0' && e.key <= '9') digit(e.key);
  if (e.key === 'Backspace') delDigit();
  if (e.key === 'Enter') tryLogin();
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  DB.getFormTemplates();

  if (AUTH.isLoggedIn()) {
    window.location.href = AUTH.getRole() === 'operator' ? 'form.html' : 'index.html';
    return;
  }

  const sites = AUTH.getSites().filter(s => s.active !== false);
  const isQR  = (params.get('return') || '').includes('plant=') || params.has('plant');

  if (isQR || sites.length === 1) {
    selectSite(sites[0].id);
  } else {
    renderSites();
    setTimeout(() => document.getElementById('site-search').focus(), 200);
  }
});
</script>
</body>
</html>
