<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Robert Quinn Ltd ‚Äî GA Inspection</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="js/data.js"></script>
<script src="js/auth.js"></script>
<script src="js/ui.js"></script>
<script src="js/firebase-config.js"></script>
<script src="js/firebase.js"></script>
<script src="js/offline.js"></script>
<style>
  :root {
    --bg: #060A14;
    --surface: #0D1421;
    --surface2: #111827;
    --border: #1A2333;
    --border2: #243044;
    --text: #E8EDF5;
    --muted: #6B7A99;
    --accent: #2E7D52;
    --accent2: #FF6B35;
    --accent3: #7B61FF;
    --danger: #FF4757;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { overflow-x: hidden !important; background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; }
  
  /* HEADER */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    position: sticky; top: 0; z-index: 50;
    display: flex; align-items: center; gap: 14px;
  }
  .header-back { background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 4px; }
  .header-info { flex: 1; min-width: 0; }
  .header-title { font-size: 16px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .header-sub { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; }
  .header-badge { font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; padding: 6px 12px; border-radius: 20px; white-space: nowrap; }

  /* PROGRESS */
  .progress-bar { height: 4px; background: var(--border); position: sticky; top: 65px; z-index: 49; }
  .progress-fill { height: 100%; background: var(--accent); transition: width 0.4s ease; }

  /* PLANT SELECTOR */
  .plant-selector { padding: 20px; }
  .selector-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
  .selector-sub { font-size: 13px; color: var(--muted); margin-bottom: 24px; }
  .plant-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
  .plant-option {
    background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
    padding: 16px; display: flex; align-items: center; gap: 14px;
    cursor: pointer; transition: all 0.2s;
  }
  .plant-option:hover, .plant-option.selected { border-color: var(--accent); background: rgba(46,125,82,0.05); }
  .plant-option .po-emoji { font-size: 28px; }
  .plant-option .po-name { font-size: 15px; font-weight: 700; }
  .plant-option .po-loc { font-size: 12px; color: var(--muted); }
  .plant-option .po-check { margin-left: auto; font-size: 20px; opacity: 0; transition: opacity 0.2s; }
  .plant-option.selected .po-check { opacity: 1; color: var(--accent); }

  /* FORM SELECTOR */
  .form-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
  .form-option { box-sizing:border-box; width:100%;
    background: var(--surface); border: 2px solid var(--border); border-radius: 14px;
    padding: 18px; cursor: pointer; transition: all 0.2s;
  }
  .form-option:hover, .form-option.selected { transform: translateX(4px); }
  .form-option-id { font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; }
  .form-option-name { font-size: 15px; font-weight: 700; margin: 4px 0; }
  .form-option-desc { font-size: 12px; color: var(--muted); }
  .form-meta { display: flex; gap: 12px; margin-top: 10px; font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; }

  /* OPERATOR SECTION */
  .op-section { padding: 0 20px 20px; }
  .section-heading { font-size: 18px; font-weight: 800; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 6px; letter-spacing: 1.5px; font-family: 'Space Mono', monospace; }
  .form-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 12px; padding: 14px 16px; color: var(--text);
    font-family: 'Syne', sans-serif; font-size: 15px;
    transition: border-color 0.2s; -webkit-appearance: none;
  }
  .form-input:focus { outline: none; border-color: var(--accent); }
  .form-input::placeholder { color: var(--muted); }
  textarea.form-input { resize: none; min-height: 80px; }

  /* CHECKLIST SECTION */
  .checklist-section { padding: 0 20px; margin-bottom: 24px; }
  .section-title {
    font-size: 13px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
    color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
  }
  .section-progress { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); margin-left: auto; }
  
  .check-item {
    background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
    margin-bottom: 8px; overflow: hidden; transition: all 0.2s;
    cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
  }
  .check-item.checked { border-color: rgba(46,125,82,0.4); background: rgba(46,125,82,0.05); }
  .check-item.failed { border-color: rgba(255,71,87,0.4); background: rgba(255,71,87,0.05); }
  .check-item-inner { display: flex; align-items: flex-start; gap: 14px; padding: 14px 16px; }
  .check-box {
    width: 26px; height: 26px; border-radius: 8px; border: 2px solid var(--border2);
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    margin-top: 1px; transition: all 0.2s; font-size: 14px;
  }
  .check-item.checked .check-box { background: var(--accent); border-color: var(--accent); }
  .check-item.failed .check-box { background: var(--danger); border-color: var(--danger); }
  .check-item.na .check-box { background: var(--muted); border-color: var(--muted); }
  .check-label { font-size: 14px; line-height: 1.4; flex: 1; padding-top: 3px; }
  
  /* Status toggle buttons inside item */
  .check-actions { display: flex; gap: 6px; padding: 0 16px 10px 56px; }
  .check-btn {
    font-size: 12px; font-family: 'Space Mono', monospace; font-weight: 700;
    padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer;
    transition: all 0.15s; letter-spacing: 0.5px; min-height: 44px; min-width: 70px;
  }
  .check-btn.pass { background: rgba(46,125,82,0.15); color: var(--accent); }
  .check-btn.pass.active { background: var(--accent); color: white; }
  .check-btn.fail-btn { background: rgba(255,71,87,0.15); color: var(--danger); }
  .check-btn.fail-btn.active { background: var(--danger); color: white; }
  .check-btn.na-btn { background: rgba(107,122,153,0.15); color: var(--muted); }
  .check-btn.na-btn.active { background: var(--muted); color: var(--bg); }

  /* SUMMARY */
  .summary-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 20px; margin: 0 20px 20px;
  }
  .summary-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
  .summary-row:last-child { border-bottom: none; }
  .score-big { font-family: 'Space Mono', monospace; font-size: 48px; font-weight: 700; text-align: center; padding: 20px 0; }

  /* STICKY FOOTER */
  .sticky-footer {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(6,10,20,0.95); backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    padding: 16px 20px;
    display: flex; gap: 12px; z-index: 100;
  }
  .btn-full { width: 100%; font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700; padding: 16px; border-radius: 12px; border: none; cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a9e68; }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-secondary2 { background: var(--surface2); color: var(--muted); border: 1px solid var(--border2); }

  /* SUCCESS SCREEN */
  .success-screen { padding: 40px 20px; text-align: center; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .success-icon { font-size: 72px; margin-bottom: 20px; animation: bounce 0.6s ease; }
  @keyframes bounce { 0%{transform:scale(0);} 60%{transform:scale(1.2);} 100%{transform:scale(1);} }
  .success-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
  .success-sub { font-size: 14px; color: var(--muted); margin-bottom: 32px; }
  .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 400px; margin-bottom: 32px; }
  .result-item { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 16px; text-align: center; }
  .result-value { font-family: 'Space Mono', monospace; font-size: 24px; font-weight: 700; }
  .result-label { font-size: 11px; color: var(--muted); margin-top: 4px; letter-spacing: 1px; }


  /* HISTORY SCREEN */
  .hist-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px 0; }
  .hist-title  { font-size:18px; font-weight:800; }
  .hist-sub    { font-size:12px; color:var(--muted); margin-top:2px; }
  .hist-list   { padding:16px 20px 100px; }
  .hist-item   { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:14px 16px; margin-bottom:10px; }
  .hist-item-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .hist-plant  { font-size:14px; font-weight:700; }
  .hist-form   { font-family:'Space Mono',monospace; font-size:12px; padding:2px 8px; border-radius:6px; }
  .hist-meta   { font-size:11px; color:var(--muted); font-family:'Space Mono',monospace; }
  .hist-score  { font-family:'Space Mono',monospace; font-size:22px; font-weight:700; }
  .hist-empty  { text-align:center; padding:60px 20px; color:var(--muted); }
  .hist-empty span { font-size:40px; display:block; margin-bottom:12px; }

  /* STEP INDICATOR */
  .steps { display: flex; align-items: center; gap: 0; margin: 20px 20px 0; }
  .step { flex: 1; text-align: center; position: relative; }
  .step-dot { width: 28px; height: 28px; border-radius: 50%; background: var(--border2); border: 2px solid var(--border2); display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; font-size: 12px; font-family: 'Space Mono', monospace; font-weight: 700; color: var(--muted); transition: all 0.3s; }
  .step.done .step-dot { background: var(--accent); border-color: var(--accent); color: #060A14; }
  .step.active .step-dot { background: transparent; border-color: var(--accent); color: var(--accent); }
  .step-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; font-family: 'Space Mono', monospace; }
  .step.active .step-label, .step.done .step-label { color: var(--text); }
  .step-line { position: absolute; top: 13px; left: 50%; right: -50%; height: 2px; background: var(--border); z-index: -1; }
  .step.done .step-line { background: var(--accent); }
  .step:last-child .step-line { display: none; }

  /* Quick all-tick */
  .quick-all { font-size: 12px; font-family: 'Space Mono', monospace; color: var(--accent); background: none; border: 1px solid rgba(0,200,150,0.3); border-radius: 6px; padding: 4px 10px; cursor: pointer; float: right; }

  .pb { padding-bottom: 90px; }

  /* INLINE LOGIN MODAL */
  .login-overlay {
    position: fixed; inset: 0; z-index: 999;
    background: rgba(6,10,20,0.97);
    display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .login-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    padding: 28px 24px; width: 100%; max-width: 360px; max-height: 90vh; overflow-y: auto; box-shadow: 0 32px 80px rgba(0,0,0,0.6);
  }
  .login-logo { text-align: center; margin-bottom: 20px; }
  .login-logo .logo-icon { font-size: 48px; }
  .login-logo .logo-name { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent); letter-spacing: 3px; margin-top: 6px; }
  .login-title { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 6px; }
  .login-sub { font-size: 12px; color: var(--muted); text-align: center; margin-bottom: 24px; }
  .login-form-group { margin-bottom: 14px; }
  .login-label { display: block; font-size: 10px; color: var(--muted); margin-bottom: 6px; letter-spacing: 2px; font-family: 'Space Mono', monospace; }
  .login-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 12px; padding: 14px 16px; color: var(--text);
    font-family: 'Syne', sans-serif; font-size: 16px; /* 16px prevents iOS zoom */
    transition: border-color 0.2s; -webkit-appearance: none; outline: none;
  }
  .login-input:focus { border-color: var(--accent); }
  .login-input::placeholder { color: var(--muted); }
  .login-pin-row { display: flex; gap: 8px; }
  .login-pin-dot {
    flex: 1; height: 52px; background: var(--surface2); border: 2px solid var(--border2);
    border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 24px; color: var(--muted); transition: all 0.2s;
  }
  .login-pin-dot.filled { border-color: var(--accent); color: var(--text); }
  .login-numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 14px; }
  .np-btn {
    height: 56px; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 12px; font-size: 20px; font-weight: 700; color: var(--text);
    cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  .np-btn:active { background: rgba(46,125,82,0.2); border-color: var(--accent); transform: scale(0.95); }
  .np-btn.del { font-size: 16px; color: var(--muted); }
  .login-error { background: rgba(255,71,87,0.1); border: 1px solid rgba(255,71,87,0.3); border-radius: 10px; padding: 10px 14px; font-size: 13px; color: var(--danger); margin-bottom: 14px; text-align: center; display: none; }
  .login-site-selector { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; margin-bottom: 14px; }
  .login-site-btn {
    background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px;
    padding: 12px 14px; cursor: pointer; text-align: left; font-family: 'Syne', sans-serif;
    color: var(--text); font-size: 13px; font-weight: 700; transition: all 0.15s;
  }
  .login-site-btn:hover, .login-site-btn:active { border-color: var(--accent); background: rgba(46,125,82,0.06); }

  /* CONNECTION STATUS PILL */
  .conn-status {
    position: fixed; top: 70px; right: 14px; z-index: 200;
    font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700; letter-spacing: 1px;
    padding: 4px 10px; border-radius: 20px; display: none; transition: all 0.3s;
  }
  .conn-status.offline { display: block; background: rgba(255,71,87,0.15); border: 1px solid rgba(255,71,87,0.4); color: var(--danger); }
  .conn-status.syncing { display: block; background: rgba(255,107,53,0.15); border: 1px solid rgba(255,107,53,0.4); color: #FF6B35; }
  .conn-status.saved { display: block; background: rgba(46,125,82,0.15); border: 1px solid rgba(46,125,82,0.4); color: var(--accent); }
</style>
</head>
<body>

<!-- CONNECTION STATUS PILL -->
<div class="conn-status" id="conn-status">‚óè OFFLINE ‚Äî saved locally</div>

<!-- INLINE LOGIN MODAL (shown instead of redirecting to login.html) -->
<div class="login-overlay" id="login-overlay" style="display:none;">
  <div class="login-card">
    <div class="login-logo">
      <div class="logo-icon">üõ°Ô∏è</div>
      <div class="logo-name">ROBERT QUINN LTD</div>
    </div>

    <!-- Step 1: Site selection (when ?site= not in URL) -->
    <div id="lo-step-site" style="display:none;">
      <div class="login-title">Select Site</div>
      <div class="login-sub">Which site are you on?</div>
      <div class="login-site-selector" id="lo-site-list"></div>
    </div>

    <!-- Step 2: Name + PIN -->
    <div id="lo-step-pin">
      <div class="login-title">Sign In</div>
      <div class="login-sub" id="lo-sub">Enter your name and site PIN to continue</div>
      <div class="login-error" id="lo-error"></div>
      <div class="login-form-group">
        <label class="login-label">YOUR NAME</label>
        <input type="text" class="login-input" id="lo-name" placeholder="e.g. John Smith" autocomplete="name" autocapitalize="words">
      </div>
      <div class="login-form-group">
        <label class="login-label">SITE PIN</label>
        <div class="login-pin-row" id="lo-pin-dots">
          <div class="login-pin-dot" id="lo-d0">‚Äì</div>
          <div class="login-pin-dot" id="lo-d1">‚Äì</div>
          <div class="login-pin-dot" id="lo-d2">‚Äì</div>
          <div class="login-pin-dot" id="lo-d3">‚Äì</div>
        </div>
        <div class="login-numpad">
          <button class="np-btn" onclick="loPad('1')">1</button>
          <button class="np-btn" onclick="loPad('2')">2</button>
          <button class="np-btn" onclick="loPad('3')">3</button>
          <button class="np-btn" onclick="loPad('4')">4</button>
          <button class="np-btn" onclick="loPad('5')">5</button>
          <button class="np-btn" onclick="loPad('6')">6</button>
          <button class="np-btn" onclick="loPad('7')">7</button>
          <button class="np-btn" onclick="loPad('8')">8</button>
          <button class="np-btn" onclick="loPad('9')">9</button>
          <button class="np-btn" onclick="loPad('')"></button>
          <button class="np-btn" onclick="loPad('0')">0</button>
          <button class="np-btn del" onclick="loPad('‚å´')">‚å´</button>
        </div>
      </div>
      <button class="btn-full btn-primary" onclick="loSubmit()" style="margin-top:14px;padding:16px;font-family:'Space Mono',monospace;font-weight:700;">Sign In & Continue ‚Üí</button>
    </div>
  </div>
</div>

<!-- SCREEN: MY SUBMISSIONS HISTORY -->
<div id="screen-status" style="display:none;">
  <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;text-align:center;background:var(--bg);">
    <div id="status-icon" style="font-size:100px;line-height:1;margin-bottom:24px;animation:statusPop 0.5s cubic-bezier(0.34,1.56,0.64,1) both;">‚úÖ</div>
    <div id="status-title" style="font-size:28px;font-weight:900;color:#00C896;font-family:'Space Mono',monospace;margin-bottom:8px;letter-spacing:-1px;">INSPECTED TODAY</div>
    <div id="status-plant" style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:20px;"></div>
    <div id="status-cards" style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:360px;margin-bottom:28px;"></div>
    <div id="status-next" style="font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:32px;letter-spacing:1px;"></div>
    <div style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:360px;">
      <div id="status-pending-btn" style="display:none;">
        <button class="btn-full btn-primary" onclick="proceedFromStatus()" id="status-fill-btn">Fill Outstanding Form</button>
      </div>
      <button class="btn-full" style="background:var(--surface2);color:var(--muted);border:1px solid var(--border);padding:14px;border-radius:12px;font-size:13px;cursor:pointer;" onclick="showScreen('select')">View All Forms</button>
    </div>
  </div>
</div>
<style>@keyframes statusPop { from { transform:scale(0.3);opacity:0; } to { transform:scale(1);opacity:1; } }</style>

<div id="screen-history" style="display:none;">
  <div class="header">
    <div class="header-info">
      <div class="header-title" id="hist-user-name">My Submissions</div>
      <div class="header-sub" id="hist-site-name"></div>
    </div>
    <button class="btn btn-primary btn-sm" onclick="showScreen('select')" style="margin:0 16px 0 0;flex-shrink:0;">+ New Form</button>
  </div>
  <div class="hist-header">
    <div>
      <div class="hist-title">My Submissions</div>
      <div class="hist-sub">Your inspection history on this site</div>
    </div>
  </div>
  <div class="hist-list" id="hist-list"></div>
  <div class="sticky-footer">
    <button class="btn-full btn-primary" onclick="showScreen('select')">Start New Inspection</button>
  </div>
</div>

<!-- STEP: SELECT PLANT & FORM -->
<div id="screen-select" style="max-width:600px;margin:0 auto;">
  <div class="header">
    <div class="header-info">
      <div class="header-title" id="sel-user-name">üõ°Ô∏è GA Forms</div>
      <div class="header-sub" id="sel-site-name">SAFETY INSPECTION</div>
    </div>
    <button id="btn-history" class="btn btn-secondary btn-sm" onclick="showHistory()" style="margin:0 16px 0 0;flex-shrink:0;display:none;">üìã My Forms</button>
  </div>

  <div id="steps-indicator"></div>

  <div id="select-content" style="padding-bottom:100px;">
    <!-- Plant selector -->
    <div id="plant-step" style="padding:20px 20px 20px 20px;">
      <div class="selector-title">Select Plant</div>
      <div class="selector-sub">Which piece of plant are you inspecting?</div>
      <div id="plant-list" class="plant-list"></div>
    </div>

    <!-- Form selector (shown after plant selected) -->
    <div id="form-step" style="padding:0 20px;display:none;width:100%;box-sizing:border-box;">
      <div class="selector-title">Select Form</div>
      <div class="selector-sub">Which inspection form do you need to fill?</div>
      <div id="form-options" class="form-options"></div>
    </div>
  </div>

  <div class="sticky-footer" style="display:flex;gap:10px;">
    <button class="btn-full btn-secondary2" id="btn-back-select" onclick="goBackSelect()" style="display:none;max-width:80px;">‚Üê Back</button>
    <button class="btn-full btn-secondary2" onclick="logout()" style="max-width:60px;" title="Log out">‚èª</button>
    <button class="btn-full btn-primary" id="btn-next-select" onclick="nextSelect()" disabled>Next ‚Üí</button>
  </div>
</div>

<!-- STEP: OPERATOR INFO -->
<div id="screen-operator" style="display:none;">
  <div class="header">
    <button class="header-back" onclick="showScreen('select')">‚Üê</button>
    <div class="header-info">
      <div class="header-title" id="op-plant-name">Plant Name</div>
      <div class="header-sub" id="op-form-name">Form Name</div>
    </div>
    <span class="header-badge" id="op-badge" style="background:rgba(0,200,150,0.1);color:var(--accent);">GA2</span>
  </div>

  <div class="op-section" style="padding-top:20px;padding-bottom:100px;">
    <div class="section-heading">Your Details</div>
    <div class="form-group">
      <label class="form-label">FULL NAME *</label>
      <input type="text" class="form-input" id="op-name" placeholder="John Smith" autocomplete="name">
    </div>
    <div class="form-group">
      <label class="form-label">COMPANY</label>
      <input type="text" class="form-input" id="op-company" placeholder="Your company name" autocomplete="organization">
    </div>
    <div class="form-group">
      <label class="form-label">DATE</label>
      <input type="date" class="form-input" id="op-date">
    </div>
    <div class="form-group">
      <label class="form-label">LICENCE / TICKET NUMBER (if applicable)</label>
      <input type="text" class="form-input" id="op-licence" placeholder="e.g. WP12345" autocomplete="off">
    </div>
    <div class="form-group">
      <label class="form-label">ADDITIONAL NOTES</label>
      <textarea class="form-input" id="op-notes" placeholder="Any defects, concerns or observations..."></textarea>
    </div>
  </div>

  <div class="sticky-footer">
    <button class="btn-full btn-secondary2" onclick="showScreen('select')" style="max-width:100px;">‚Üê Back</button>
    <button class="btn-full btn-primary" onclick="startChecklist()">Start Inspection ‚Üí</button>
  </div>
</div>

<!-- STEP: CHECKLIST -->
<div id="screen-checklist" style="display:none;">
  <div class="header">
    <button class="header-back" onclick="showScreen('operator')">‚Üê</button>
    <div class="header-info">
      <div class="header-title" id="cl-plant-name">Plant</div>
      <div class="header-sub" id="cl-progress-text">0 / 0 checked</div>
    </div>
    <span class="header-badge" id="cl-score-badge" style="background:rgba(0,200,150,0.1);color:var(--accent);">0%</span>
  </div>
  <div class="progress-bar"><div class="progress-fill" id="cl-progress-fill" style="width:0%"></div></div>
  
  <div id="checklist-content" class="pb"></div>

  <div class="sticky-footer">
    <button class="btn-full btn-secondary2" onclick="showScreen('operator')" style="max-width:100px;">‚Üê Back</button>
    <button class="btn-full btn-primary" id="btn-submit" onclick="submitForm()">Submit ‚úì</button>
  </div>
</div>

<!-- SUCCESS SCREEN -->
<div id="screen-success" style="display:none;">
  <div class="success-screen">
    <div class="success-icon" id="success-icon">‚úÖ</div>
    <div class="success-title" id="success-title">Inspection Complete!</div>
    <div class="success-sub" id="success-sub">Submission recorded successfully</div>
    
    <div class="result-grid" id="result-grid"></div>

    <div style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:400px;">
      <button class="btn-full btn-primary" onclick="startNew()">üìã New Inspection</button>
      <button class="btn-full btn-secondary2" onclick="window.close()">Close</button>
    </div>

    <div style="margin-top:24px;font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;">
      Form submitted ¬∑ <span id="success-time"></span>
    </div>
  </div>
</div>

<script>
// State
let sigData = null; // signature pad data (optional)
let state = {
  plantId: null,
  formId: null,
  plant: null,
  template: null,
  answers: [], // 0=unchecked, 1=pass, 2=fail, 3=na
  step: 'plant' // plant | form
};

// URL Params
const params = new URLSearchParams(window.location.search);
const urlPlant = params.get('plant');
const urlForm = params.get('form');

// ============================================================
// SCREEN MANAGEMENT
// ============================================================
function showScreen(name) {
  ['select','operator','checklist','success','history','status'].forEach(s => {
    const el = document.getElementById('screen-' + s);
    if (el) el.style.display = s === name ? '' : 'none';
  });
}

// ============================================================
// PLANT & FORM SELECTION
// ============================================================
function renderPlantList() {
  const plants = DB.getPlants();
  const list = document.getElementById('plant-list');
  list.innerHTML = plants.map(p => `
    <div class="plant-option ${state.plantId === p.id ? 'selected' : ''}" onclick="selectPlant('${p.id}')">
      <span class="po-emoji">${p.photo || 'üèóÔ∏è'}</span>
      <div style="flex:1;">
        <div class="po-name">${p.name}</div>
        <div class="po-loc">üìç ${p.location} ¬∑ <span style="font-family:'Space Mono',monospace;font-size:11px;">${p.id}</span></div>
      </div>
      <span class="po-check">‚úì</span>
    </div>`).join('');
}

function selectPlant(id) {
  state.plantId = id;
  state.plant = DB.getPlant(id);
  renderPlantList();
  state.step = 'form';
  document.getElementById('plant-step').style.display = 'none';
  document.getElementById('form-step').style.display = '';
  document.getElementById('btn-back-select').style.display = '';
  renderFormOptions();
}

function renderFormOptions() {
  // Only show forms relevant to this plant type
  const plant     = state.plant;
  const templates = plant ? DB.getFormsForPlant(plant) : DB.getFormTemplates();
  const opts      = document.getElementById('form-options');

  // Auto-select the primary GA2 form if only one GA2 and none selected yet
  if (!state.formId) {
    const primary = templates.find(t => t.id.startsWith('GA2'));
    if (primary) { state.formId = primary.id; state.template = primary; document.getElementById('btn-next-select').disabled = false; }
  }

  opts.innerHTML = templates.map(t => {
    const totalItems = t.sections.reduce((sum,s) => sum + s.items.length, 0);
    const colorMap   = { 'GA2-MEWP':'#00C896','GA2-EXC':'#00C896','GA2-DMP':'#00C896','GA2-CRANE':'#00C896','GA2-GEN':'#00C896','GA2-COMP':'#00C896','GA2-FWORK':'#00C896','GA2-TELEH':'#00C896','GA3':'#FF6B35','GA4':'#7B61FF','GL1':'#CC3333' };
    const col        = colorMap[t.id] || 'var(--accent)';
    const isSelected = state.formId === t.id;
    // Badge label: GA2 series ‚Üí show "DAILY", GA3 ‚Üí "WEEKLY", GA4 ‚Üí "SERVICE", GL1 ‚Üí "PRE-LIFT"
    const badge = t.id.startsWith('GA2') ? 'DAILY' : t.id === 'GA3' ? 'WEEKLY' : t.id === 'GA4' ? 'SERVICE' : t.id === 'GL1' ? 'PRE-LIFT' : '';
    const badgeHtml = badge ? `<span style="font-size:9px;letter-spacing:1px;background:rgba(255,255,255,0.06);padding:2px 7px;border-radius:4px;color:var(--muted);font-family:'Space Mono',monospace;">${badge}</span>` : '';
    return `<div class="form-option ${isSelected ? 'selected' : ''}"
                 style="border-color:${isSelected ? col : 'var(--border)'};"
                 onclick="selectForm('${t.id}')">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
        <div class="form-option-id" style="color:${col};">${t.id}</div>
        ${badgeHtml}
      </div>
      <div class="form-option-name">${t.name}</div>
      <div class="form-option-desc">${t.description}</div>
      <div class="form-meta">
        <span>üìã ${t.sections.length} sections</span>
        <span>‚úì ${totalItems} checkpoints</span>
      </div>
    </div>`;
  }).join('');
}

function selectForm(id) {
  state.formId = id;
  state.template = DB.getFormTemplate(id);
  renderFormOptions();
  document.getElementById('btn-next-select').disabled = false;
}

function nextSelect() {
  if (!state.plantId || !state.formId) return;
  // Set operator details
  document.getElementById('op-plant-name').textContent = state.plant.photo + ' ' + state.plant.name;
  document.getElementById('op-form-name').textContent = state.template.name;
  document.getElementById('op-badge').textContent = state.formId;
  document.getElementById('op-badge').style.color = 'var(--accent)';
  
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('op-date').value = today;
  
  // Load saved operator name from settings
  const settings = DB.getSettings();
  
  showScreen('operator');
}

function goBackSelect() {
  state.step = 'plant';
  state.formId = null;
  document.getElementById('plant-step').style.display = '';
  document.getElementById('form-step').style.display = 'none';
  document.getElementById('btn-back-select').style.display = 'none';
  document.getElementById('btn-next-select').disabled = true;
}

// ============================================================
// CHECKLIST
// ============================================================
function startChecklist() {
  const name = document.getElementById('op-name').value.trim();
  const company = document.getElementById('op-company').value.trim();
  if (!name) { UI.toast('Please enter your name', 'error'); return; }
  // company is optional
  
  // Init answers
  const totalItems = state.template.sections.reduce((sum, s) => sum + s.items.length, 0);
  state.answers = new Array(totalItems).fill(0);
  
  renderChecklist();
  showScreen('checklist');
  updateProgress();
}

function renderChecklist() {
  document.getElementById('cl-plant-name').textContent = state.plant.name;
  const content = document.getElementById('checklist-content');
  let html = '';
  let idx = 0;
  
  state.template.sections.forEach((sec, si) => {
    html += `<div class="checklist-section" style="margin-top:${si===0?'20px':'0'};">
      <div class="section-title">
        <span>${si+1}. ${sec.title}</span>
        <button class="quick-all" onclick="tickAll(${idx}, ${idx + sec.items.length - 1})">‚úì All Pass</button>
        <span class="section-progress" id="sec-prog-${si}">0/${sec.items.length}</span>
      </div>`;
    
    sec.items.forEach((item, ii) => {
      const itemIdx = idx + ii;
      html += `<div class="check-item" id="item-${itemIdx}" onclick="toggleItem(${itemIdx})">
        <div class="check-item-inner">
          <div class="check-box" id="box-${itemIdx}"></div>
          <div class="check-label">${item}</div>
        </div>
        <div class="check-actions" id="actions-${itemIdx}" style="display:none;">
          <button class="check-btn pass" onclick="event.stopPropagation();setItemStatus(${itemIdx},1)">‚úì PASS</button>
          <button class="check-btn fail-btn" onclick="event.stopPropagation();setItemStatus(${itemIdx},2)">‚úï FAIL</button>
          <button class="check-btn na-btn" onclick="event.stopPropagation();setItemStatus(${itemIdx},3)">N/A</button>
        </div>
      </div>`;
    });
    html += `</div>`;
    idx += sec.items.length;
  });
  
  content.innerHTML = html;
}

let openItem = null;
function toggleItem(idx) {
  if (openItem !== null && openItem !== idx) {
    document.getElementById('actions-' + openItem).style.display = 'none';
  }
  const actions = document.getElementById('actions-' + idx);
  const isOpen = actions.style.display !== 'none';
  actions.style.display = isOpen ? 'none' : '';
  openItem = isOpen ? null : idx;
  
  // If unchecked, quick-pass on first tap
  if (!isOpen && state.answers[idx] === 0) {
    setItemStatus(idx, 1);
  }
}

function setItemStatus(idx, status) {
  state.answers[idx] = status;
  const item = document.getElementById('item-' + idx);
  const box = document.getElementById('box-' + idx);
  item.className = 'check-item' + (status === 1 ? ' checked' : status === 2 ? ' failed' : status === 3 ? ' na' : '');
  box.textContent = status === 1 ? '‚úì' : status === 2 ? '‚úï' : status === 3 ? '‚Äî' : '';
  updateProgress();
  // Autosave progress so operator can restore if they close/reload
  autosaveDraft();
}

function tickAll(from, to) {
  for (let i = from; i <= to; i++) setItemStatus(i, 1);
}

function updateProgress() {
  const total = state.answers.length;
  const answered = state.answers.filter(a => a > 0).length;
  const passed = state.answers.filter(a => a === 1 || a === 3).length;
  const pct = total > 0 ? Math.round((passed / total) * 100) : 0;
  
  document.getElementById('cl-progress-text').textContent = `${answered} / ${total} answered`;
  document.getElementById('cl-progress-fill').style.width = `${(answered/total)*100}%`;
  
  const color = pct === 100 ? '#00C896' : pct >= 90 ? '#FF6B35' : '#FF4757';
  const badge = document.getElementById('cl-score-badge');
  badge.textContent = pct + '%';
  badge.style.color = color;
  badge.style.background = color + '22';
  
  // Update section progress
  let idx = 0;
  state.template.sections.forEach((sec, si) => {
    const secAnswered = state.answers.slice(idx, idx + sec.items.length).filter(a => a > 0).length;
    const el = document.getElementById('sec-prog-' + si);
    if (el) el.textContent = `${secAnswered}/${sec.items.length}`;
    idx += sec.items.length;
  });
}

// ============================================================
// SUBMIT
// ============================================================
async function submitForm() {
  const name = document.getElementById('op-name').value.trim();
  const company = document.getElementById('op-company').value.trim();
  const notes = document.getElementById('op-notes').value.trim();
  const date = document.getElementById('op-date').value;
  const licence = document.getElementById('op-licence').value.trim();
  
  const total = state.answers.length;
  const passed = state.answers.filter(a => a === 1 || a === 3).length;
  const failed = state.answers.filter(a => a === 2).length;
  const unanswered = state.answers.filter(a => a === 0).length;
  const score = Math.round((passed / total) * 100);

  if (unanswered > 0) {
    if (!confirm(unanswered + ' item(s) are unanswered. Submit anyway?')) return;
  }

  const btnSubmit = document.getElementById('btn-submit');
  if (btnSubmit._submitting) return;
  btnSubmit._submitting = true;
  if (btnSubmit) { btnSubmit.disabled = true; btnSubmit.textContent = 'Submitting‚Ä¶'; }
  const btnTimeout = setTimeout(() => {
    if (btnSubmit) { btnSubmit._submitting = false; btnSubmit.disabled = false; btnSubmit.textContent = 'Submit ‚úì'; }
  }, 8000);

  const safeSignature = (typeof sigData !== 'undefined') ? sigData : null;
  const sub = DB.addSubmission({
    siteId: AUTH.getSiteId() || params.get('site') || '',
    plantId: state.plantId,
    formId: state.formId,
    operatorName: name,
    companyName: company,
    date: date,
    licence: licence,
    notes: notes,
    answers: state.answers,
    total: total,
    passed: passed,
    failed: failed,
    signature: safeSignature,
    plantName: state.plant?.name || state.plantId,
    plantLocation: state.plant?.location || '',
  });

  // Auto-log each FAIL as a defect
  const defects = [];
  if (failed > 0) {
    const template = DB.getFormTemplate(state.formId);
    let idx = 0;
    (template?.sections || []).forEach(sec => {
      sec.items.forEach(item => {
        if (state.answers[idx] === 2) {
          const def = DB.addDefect({
            plantId: state.plantId,
            plantName: state.plant?.name || state.plantId,
            formId:  state.formId,
            operatorName: name,
            item:    item,
            section: sec.title,
          });
          defects.push(def);
        }
        idx++;
      });
    });
  }

  // Notification
  const notif = {
    siteId: AUTH.getSiteId() || params.get('site') || '',
    title: failed > 0 ? `‚ö†Ô∏è Defects Found ‚Äî ${state.plant.name}` : `‚úÖ ${state.formId} Completed ‚Äî ${state.plant.name}`,
    message: failed > 0
      ? `${name} reported ${failed} failed item(s) on ${state.formId}. Logged to Defect Tracker.`
      : `${name} completed inspection with ${score}% score.`,
    type: failed > 0 ? 'warning' : 'success',
    plantId: state.plantId,
    link: failed > 0 ? 'defects' : 'submissions'
  };
  DB.addNotification(notif);

  // Push to API server ‚Äî queue offline if no connection
  if (typeof FIREBASE_URL !== 'undefined' && FIREBASE_URL) {
    const siteId = AUTH.getSiteId() || params.get('site') || '';
    if (siteId) {
      FBSYNC.init(FIREBASE_URL, siteId);
      const notifObj = { ...notif, id: 'N-' + Date.now(), createdAt: sub.submittedAt, read: false };

      if (navigator.onLine) {
        try {
          await Promise.all([
            FBSYNC.writeSubmission(sub),
            FBSYNC.writeNotification(notifObj),
            ...defects.map(d => FBSYNC.writeDefect(d))
          ]);
        } catch(e) {
          // Failed ‚Äî queue for later
          console.warn('Firebase write failed ‚Äî queuing offline', e);
          OFFLINE.enqueue(sub, defects, notifObj);
        }
      } else {
        // No connection ‚Äî queue for sync when back online
        OFFLINE.enqueue(sub, defects, notifObj);
      }
      updateConnStatus();
    }
  }

  clearTimeout(btnTimeout);
  clearDraft();

    // Show success
  const color = score === 100 ? '#00C896' : score >= 90 ? '#FF6B35' : '#FF4757';
  const icon = score === 100 ? 'üéâ' : score >= 90 ? '‚ö†Ô∏è' : 'üö®';
  document.getElementById('success-icon').textContent = icon;
  document.getElementById('success-title').textContent = score === 100 ? 'Perfect Score!' : score >= 90 ? 'Completed ‚Äî Defects Found' : 'Inspection Failed';
  document.getElementById('success-sub').textContent = `${state.formId} submitted for ${state.plant.name}`;
  document.getElementById('success-time').textContent = new Date().toLocaleTimeString('en-GB');
  
  document.getElementById('result-grid').innerHTML = `
    <div class="result-item" style="grid-column:1/-1;">
      <div class="result-value" style="color:${color};font-size:48px;">${score}%</div>
      <div class="result-label">OVERALL SCORE</div>
    </div>
    <div class="result-item">
      <div class="result-value" style="color:#00C896;">${passed}</div>
      <div class="result-label">PASSED</div>
    </div>
    <div class="result-item">
      <div class="result-value" style="color:${failed>0?'#FF4757':'var(--muted)'};">${failed}</div>
      <div class="result-label">FAILED</div>
    </div>
    <div class="result-item">
      <div class="result-value">${total}</div>
      <div class="result-label">TOTAL ITEMS</div>
    </div>
    <div class="result-item">
      <div class="result-value" style="font-size:16px;">${name.split(' ')[0]}</div>
      <div class="result-label">OPERATOR</div>
    </div>
  `;
  
  showScreen('success');
}

function startNew() {
  state = { plantId: null, formId: null, plant: null, template: null, answers: [], step: 'plant' };
  goBackSelect();
  document.getElementById('plant-step').style.display = '';
  document.getElementById('btn-back-select').style.display = 'none';
  document.getElementById('btn-next-select').disabled = true;
  showScreen('select');
  renderPlantList();
}

// ============================================================
// INLINE LOGIN MODAL
// ============================================================
let loPin = '';
let loSiteId = null;
let urlTokPin = null;

function loShowSiteStep() {
  document.getElementById('lo-step-site').style.display = '';
  document.getElementById('lo-step-pin').style.display = 'none';
  const sites = AUTH.getSites().filter(s => s.active !== false);
  document.getElementById('lo-site-list').innerHTML = sites.map(s =>
    `<button class="login-site-btn" onclick="loSelectSite('${s.id}')">${s.name || s.id}</button>`
  ).join('');
}

function loSelectSite(siteId) {
  loSiteId = siteId;
  document.getElementById('lo-step-site').style.display = 'none';
  document.getElementById('lo-step-pin').style.display = '';
  // Pre-fill last used name
  const lastName = localStorage.getItem('ga_last_op_name') || '';
  if (lastName) document.getElementById('lo-name').value = lastName;
}

function loPad(key) {
  if (key === '‚å´' || key === '') {
    loPin = loPin.slice(0, -1);
  } else if (loPin.length < 4) {
    loPin += key;
  }
  // Update dots
  for (let i = 0; i < 4; i++) {
    const d = document.getElementById('lo-d' + i);
    if (d) {
      d.textContent = i < loPin.length ? '‚óè' : '‚Äì';
      d.className = 'login-pin-dot' + (i < loPin.length ? ' filled' : '');
    }
  }
  // Auto-submit when 4 digits entered
  if (loPin.length === 4) setTimeout(loSubmit, 200);
}

function loSubmit() {
  const name = (document.getElementById('lo-name').value || '').trim();
  const errEl = document.getElementById('lo-error');
  errEl.style.display = 'none';

  if (!name) {
    errEl.textContent = 'Please enter your name';
    errEl.style.display = '';
    return;
  }
  if (loPin.length < 4) {
    errEl.textContent = 'Please enter the 4-digit site PIN';
    errEl.style.display = '';
    return;
  }

  // Accept PIN if it matches localStorage OR the QR-embedded tok= token
  if (AUTH.isOperatorPin(loPin, loSiteId) || (urlTokPin && loPin === urlTokPin)) {
    AUTH.setOperatorSession(name, loSiteId);
    localStorage.setItem('ga_last_op_name', name);
    localStorage.setItem('ga_last_site', loSiteId);
    // Seed site data locally so DB calls work after login
    const existingSite = AUTH.getSite(loSiteId);
    if (!existingSite) {
      const sn = params.get('sn') || loSiteId;
      AUTH.saveSite({ id: loSiteId, name: sn, operatorPin: loPin, active: true });
    }
    document.getElementById('login-overlay').style.display = 'none';
    initAfterLogin();
    return;
  }

  // Try named staff PIN
  const user = AUTH.findUserByPin(loPin, loSiteId);
  if (user) {
    AUTH.setSession(user, loSiteId);
    document.getElementById('login-overlay').style.display = 'none';
    initAfterLogin();
    return;
  }

  // Wrong PIN
  errEl.textContent = 'Incorrect PIN ‚Äî please try again';
  errEl.style.display = '';
  loPin = '';
  for (let i = 0; i < 4; i++) {
    const d = document.getElementById('lo-d' + i);
    if (d) { d.textContent = '‚Äì'; d.className = 'login-pin-dot'; }
  }
}

// ============================================================
// CONNECTION STATUS
// ============================================================
function updateConnStatus() {
  const pill = document.getElementById('conn-status');
  if (!pill) return;
  const pending = OFFLINE.getPendingCount();
  if (!navigator.onLine) {
    pill.className = 'conn-status offline';
    pill.textContent = '‚óè OFFLINE ‚Äî forms saved locally';
  } else if (pending > 0) {
    pill.className = 'conn-status syncing';
    pill.textContent = `‚Üë ${pending} pending sync`;
  } else {
    pill.className = 'conn-status';
  }
}

// ============================================================
// HISTORY & LOGOUT
// ============================================================
function showHistory() {
  showScreen('history');
  renderHistory();
}

function renderHistory() {
  const session = AUTH.getSession();
  const userName = session?.name || 'Operator';
  const site = AUTH.getSite(session?.siteId);

  document.getElementById('hist-user-name').textContent = 'üë∑ ' + userName;
  document.getElementById('hist-site-name').textContent = site ? 'üìç ' + site.name : '';

  const allSubs = DB.getSubmissions();
  const mySubs  = allSubs.filter(s => s.operatorName === userName).sort((a,b) => new Date(b.submittedAt) - new Date(a.submittedAt));

  const list = document.getElementById('hist-list');
  if (!mySubs.length) {
    list.innerHTML = `<div class="hist-empty"><span>üìã</span>No submissions yet.<br>Complete your first inspection to see your history here.</div>`;
    return;
  }

  list.innerHTML = mySubs.map(s => {
    const score = Math.round((s.passed / s.total) * 100);
    const color = score === 100 ? '#00C896' : score >= 90 ? '#FF6B35' : '#FF4757';
    const plant = DB.getPlant(s.plantId);
    const date  = new Date(s.submittedAt).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
    const time  = new Date(s.submittedAt).toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
    const failBadge = s.failed > 0 ? `<span style="background:rgba(255,71,87,0.12);color:var(--danger);padding:2px 8px;border-radius:6px;font-size:10px;font-family:'Space Mono',monospace;">${s.failed} FAIL${s.failed!==1?'S':''}</span>` : '';
    const pendingBadge = s._pending ? `<span style="background:rgba(255,107,53,0.12);color:#FF6B35;padding:2px 8px;border-radius:6px;font-size:10px;font-family:'Space Mono',monospace;">PENDING SYNC</span>` : '';
    return `<div class="hist-item">
      <div class="hist-item-top">
        <div>
          <div class="hist-plant">${plant?.photo||'üèóÔ∏è'} ${plant?.name||s.plantId}</div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
            <span class="hist-form" style="background:rgba(46,125,82,0.1);color:var(--accent);">${s.formId}</span>
            ${failBadge}${pendingBadge}
          </div>
        </div>
        <div class="hist-score" style="color:${color};">${score}%</div>
      </div>
      <div class="hist-meta">${date} ¬∑ ${time} ¬∑ ${s.passed}/${s.total} passed</div>
    </div>`;
  }).join('');
}

function logout() {
  AUTH.clearSession();
  window.location.href = 'login.html';
}

// ============================================================
// AUTOSAVE FORM PROGRESS
// ============================================================
const AUTOSAVE_KEY = 'ga_form_draft';

function autosaveDraft() {
  try {
    const draft = {
      plantId: state.plantId,
      formId: state.formId,
      answers: state.answers,
      name: document.getElementById('op-name')?.value || '',
      company: document.getElementById('op-company')?.value || '',
      licence: document.getElementById('op-licence')?.value || '',
      notes: document.getElementById('op-notes')?.value || '',
      date: document.getElementById('op-date')?.value || '',
      savedAt: Date.now()
    };
    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(draft));
  } catch {}
}

function clearDraft() {
  try { localStorage.removeItem(AUTOSAVE_KEY); } catch {}
}

function loadDraft() {
  try {
    const d = JSON.parse(localStorage.getItem(AUTOSAVE_KEY));
    if (!d) return null;
    // Expire drafts after 24 hours
    if (Date.now() - d.savedAt > 86400000) { clearDraft(); return null; }
    return d;
  } catch { return null; }
}

// ============================================================
// INIT
// ============================================================
function initAfterLogin() {
  const session = AUTH.getSession();
  const siteId = session?.siteId;

  // Init Firebase
  if (typeof FIREBASE_URL !== 'undefined' && FIREBASE_URL && siteId) {
    FBSYNC.init(FIREBASE_URL, siteId);
    // Sync any queued offline submissions
    OFFLINE.syncAll(FIREBASE_URL, siteId);
  }

  // Pre-fill operator details
  if (session) {
    const nameEl = document.getElementById('op-name');
    const lastOpName = localStorage.getItem('ga_last_op_name') || '';
    if (nameEl && session.name) nameEl.value = session.name;
    else if (nameEl && lastOpName) nameEl.value = lastOpName;

    const site = AUTH.getSite(siteId);
    const compEl = document.getElementById('op-company');
    if (compEl && site) compEl.value = site.company || 'Robert Quinn Ltd';

    const dateEl = document.getElementById('op-date');
    if (dateEl && !dateEl.value) dateEl.value = new Date().toISOString().split('T')[0];

    const selName = document.getElementById('sel-user-name');
    const selSite = document.getElementById('sel-site-name');
    if (selName) selName.textContent = (AUTH.ROLES[session.role]?.icon || 'üë§') + ' ' + session.name;
    if (selSite) selSite.textContent = site ? 'üìç ' + site.name : 'GA SAFETY INSPECTION';

    if (session.role === 'operator') {
      const btn = document.getElementById('btn-history');
      if (btn) btn.style.display = '';
    }
  }

  DB.getPlants();
  DB.getFormTemplates();
  renderPlantList();

  // STATUS CHECK on QR scan
  function checkPlantStatus(plantId, plant) {
    if (!plantId || !plant) return false;
    const today = new Date().toISOString().split('T')[0];
    const allSubs = JSON.parse(localStorage.getItem('submissions')||'[]');
    const isTower = (plant.formType||'') === 'GA2-TOWER';
    let requiredSubs;
    if (isTower) {
      const weekAgo = new Date(Date.now()-7*24*60*60*1000).toISOString().split('T')[0];
      requiredSubs = allSubs.filter(s=>s.plantId===plantId&&s.formId==='GA2-TOWER'&&(s.date||s.submittedAt||'')>=weekAgo);
    } else {
      requiredSubs = allSubs.filter(s=>s.plantId===plantId&&(s.date||s.submittedAt||'').startsWith(today));
    }
    if (requiredSubs.length === 0) return false;

    const templates = DB.getFormTemplates();
    const plantForms = templates.filter(t => !plant.formType || t.id === plant.formType || !t.id.startsWith('GA2'));
    const ga2Forms = plantForms.filter(t=>t.id.startsWith('GA2'));
    const filledIds = new Set(requiredSubs.map(s=>s.formId));
    const pendingForms = ga2Forms.filter(t=>!filledIds.has(t.id));

    const cards = ga2Forms.map(t=>{
      const sub = requiredSubs.find(s=>s.formId===t.id);
      const done = !!sub;
      const score = sub ? Math.round(sub.score||0) : null;
      const sc = score>=90?'#00C896':score>=70?'#C9A84C':'#FF4757';
      const time = sub ? new Date(sub.submittedAt||sub.date||'').toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit'}) : '';
      return '<div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;background:var(--surface);border:2px solid '+(done?'#00C89633':'var(--border)')+';">'+
        '<span style="font-size:24px;">'+(done?'‚úÖ':'‚è≥')+'</span>'+
        '<div style="flex:1;text-align:left;"><div style="font-size:13px;font-weight:700;color:var(--text);">'+t.id+'</div>'+
        '<div style="font-size:11px;color:var(--muted);">'+(done?(sub.operatorName||'Unknown')+' ¬∑ '+time:'Not yet completed')+'</div></div>'+
        (done&&score!==null?'<div style="font-size:16px;font-weight:900;font-family:Space Mono,monospace;color:'+sc+';">'+score+'%</div>':'')+
        '</div>';
    }).join('');

    const allDone = pendingForms.length === 0;
    let nextDue = '';
    if (isTower) {
      const last = requiredSubs.sort((a,b)=>(b.submittedAt||b.date||'').localeCompare(a.submittedAt||a.date||''))[0];
      if (last) { const d=new Date(new Date(last.submittedAt||last.date||'').getTime()+7*24*60*60*1000); nextDue='NEXT INSPECTION DUE: '+d.toLocaleDateString('en-IE',{weekday:'short',day:'2-digit',month:'short',year:'numeric'}).toUpperCase(); }
    } else {
      const tom=new Date(); tom.setDate(tom.getDate()+1);
      nextDue='NEXT INSPECTION DUE: '+tom.toLocaleDateString('en-IE',{weekday:'short',day:'2-digit',month:'short',year:'numeric'}).toUpperCase();
    }

    document.getElementById('status-icon').textContent = allDone?'‚úÖ':'‚ö†Ô∏è';
    document.getElementById('status-title').textContent = allDone?'INSPECTED TODAY':'PARTIALLY DONE';
    document.getElementById('status-title').style.color = allDone?'#00C896':'#C9A84C';
    document.getElementById('status-plant').textContent = (plant.photo||'') + ' ' + (plant.name||plantId);
    document.getElementById('status-cards').innerHTML = cards;
    document.getElementById('status-next').textContent = nextDue;
    if (!allDone && pendingForms.length>0) {
      window._pendingFormId = pendingForms[0].id;
      document.getElementById('status-fill-btn').textContent = 'Fill ' + pendingForms[0].id + ' Now';
      document.getElementById('status-pending-btn').style.display = '';
    } else {
      document.getElementById('status-pending-btn').style.display = 'none';
    }
    showScreen('status');
    return true;
  }

  function proceedFromStatus() {
    if (window._pendingFormId && state.plant) {
      state.step='form';
      document.getElementById('plant-step').style.display='none';
      document.getElementById('form-step').style.display='';
      document.getElementById('btn-back-select').style.display='';
      renderFormOptions();
      selectForm(window._pendingFormId);
      showScreen('select');
    } else { showScreen('select'); }
  }

  // Handle URL params
  if (urlPlant) {
    state.plantId = urlPlant;
    state.plant = DB.getPlant(urlPlant);

    if (!state.plant) {
      // Plant not in localStorage ‚Äî fetch all plants from server
      try {
        const siteId = params.get('site') || '';
        const remote = await fetch('https://46.225.83.168.nip.io/api/plants?site_id=' + siteId).then(r=>r.json()).catch(()=>[]);
        if (Array.isArray(remote) && remote.length > 0) {
          const parsed = remote.map(p => {
            try {
              const base = typeof p.data==='string' && p.data ? JSON.parse(p.data) : {};
              return {...base, id:p.id||base.id, name:p.name||base.name, location:p.location||base.location,
                photo:p.photo||base.photo, formType:p.form_type||p.formType||base.formType,
                type:p.type||base.type, siteId:p.site_id||base.siteId||''};
            } catch(e){return p;}
          });
          DB.sset('plants', parsed);
          state.plant = parsed.find(p => p.id === urlPlant) || null;
        }
      } catch(e) { console.warn('plant fetch failed', e); }
    }

    if (state.plant) {
      const statusShown = AUTH.isLoggedIn() ? checkPlantStatus(urlPlant, state.plant) : false;
      if (!statusShown) {
        state.step = 'form';
        document.getElementById('plant-step').style.display = 'none';
        document.getElementById('form-step').style.display = '';
        document.getElementById('btn-back-select').style.display = '';
        renderFormOptions();
        if (urlForm) { selectForm(urlForm); }
      }
    }
  }

  // Check for and offer to restore autosaved draft
  const draft = loadDraft();
  if (draft && draft.plantId === urlPlant && draft.formId && draft.answers?.length) {
    setTimeout(() => {
      if (confirm('You have an unfinished inspection draft. Would you like to restore it?')) {
        state.plantId = draft.plantId;
        state.plant = DB.getPlant(draft.plantId) || state.plant;
        state.formId = draft.formId;
        state.template = DB.getFormTemplate(draft.formId);
        state.answers = draft.answers;
        if (draft.name) { const el = document.getElementById('op-name'); if (el) el.value = draft.name; }
        if (draft.company) { const el = document.getElementById('op-company'); if (el) el.value = draft.company; }
        if (draft.licence) { const el = document.getElementById('op-licence'); if (el) el.value = draft.licence; }
        if (draft.notes) { const el = document.getElementById('op-notes'); if (el) el.value = draft.notes; }
        if (draft.date) { const el = document.getElementById('op-date'); if (el) el.value = draft.date; }
        renderChecklist();
        showScreen('checklist');
        updateProgress();
      }
    }, 300);
  }

  updateConnStatus();
}

document.addEventListener('DOMContentLoaded', () => {
  // Register Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }

  // Track connection status
  window.addEventListener('online', updateConnStatus);
  window.addEventListener('offline', updateConnStatus);

  // Handle auth ‚Äî show inline modal instead of redirecting
  if (!AUTH.isLoggedIn()) {
    const overlay = document.getElementById('login-overlay');
    overlay.style.display = 'flex';

    // Determine site from URL ?site= param, or last used site, or show picker
    const urlSite = params.get('site');
    const urlTok = params.get('tok');  // base64 PIN token from QR code
    const lastSite = AUTH.getLastSiteId();
    const sites = AUTH.getSites().filter(s => s.active !== false);

    // Store tok for PIN validation on fresh devices (no localStorage)
    if (urlTok) {
      try {
        const decoded = atob(urlTok);
        if (decoded.startsWith('op:')) urlTokPin = decoded.split(':')[1];
      } catch {}
    }

    if (urlSite) {
      loSiteId = urlSite;
      document.getElementById('lo-step-site').style.display = 'none';
      document.getElementById('lo-step-pin').style.display = '';
      // Pre-fill last operator name
      const lastName = localStorage.getItem('ga_last_op_name') || '';
      if (lastName) document.getElementById('lo-name').value = lastName;
      const siteName = AUTH.getSite(urlSite)?.name || urlSite;
      document.getElementById('lo-sub').textContent = `Site: ${siteName}`;
    } else if (lastSite && AUTH.getSite(lastSite) && sites.length <= 1) {
      loSiteId = lastSite;
      document.getElementById('lo-step-site').style.display = 'none';
      document.getElementById('lo-step-pin').style.display = '';
      const lastName = localStorage.getItem('ga_last_op_name') || '';
      if (lastName) document.getElementById('lo-name').value = lastName;
    } else {
      loShowSiteStep();
    }

    // Focus name field
    setTimeout(() => document.getElementById('lo-name')?.focus(), 200);
    return;
  }

  initAfterLogin();
});
</script>
</body>
</html>
