<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Robert Quinn Ltd ‚Äî Lifting Register</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™ù</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="js/data.js"></script>
<script src="js/auth.js"></script>
<script src="js/ui.js"></script>
<style>
  :root {
    --bg:#060A14; --surface:#0D1421; --surface2:#111827;
    --border:#1A2333; --border2:#243044;
    --text:#E8EDF5; --muted:#6B7A99;
    --accent:#2E7D52; --accent-light:#3a9e68;
    --gold:#C9A84C; --danger:#FF4757; --warning:#FFB800;
    --q-green:#2E7D52; --q-yellow:#C9A84C; --q-red:#CC3333; --q-blue:#2255AA;
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; min-height:100vh; }
  body::before {
    content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
    background-image:linear-gradient(rgba(46,125,82,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(46,125,82,0.03) 1px,transparent 1px);
    background-size:60px 60px; animation:gridMove 20s linear infinite;
  }
  @keyframes gridMove { from{background-position:0 0} to{background-position:60px 60px} }

  .topbar {
    position:sticky; top:0; z-index:50;
    background:rgba(6,10,20,0.9); backdrop-filter:blur(12px);
    border-bottom:1px solid var(--border);
    padding:14px 24px; display:flex; align-items:center; gap:16px;
  }
  .back-btn { background:var(--surface2); border:1px solid var(--border2); color:var(--muted); padding:8px 14px; border-radius:8px; font-family:'Space Mono',monospace; font-size:12px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:6px; transition:all 0.2s; }
  .back-btn:hover { color:var(--text); }
  .topbar-title { font-size:18px; font-weight:800; flex:1; }
  .btn { font-family:'Space Mono',monospace; font-size:12px; font-weight:700; padding:9px 18px; border-radius:8px; border:none; cursor:pointer; transition:all 0.2s; display:inline-flex; align-items:center; gap:7px; }
  .btn-primary { background:var(--accent); color:white; }
  .btn-primary:hover { background:var(--accent-light); }
  .btn-secondary { background:transparent; color:var(--muted); border:1px solid var(--border2); }
  .btn-secondary:hover { background:var(--surface2); color:var(--text); }
  .btn-danger { background:var(--danger); color:white; }
  .btn-sm { padding:6px 12px; font-size:11px; }

  .content { padding:24px; position:relative; z-index:1; max-width:1400px; margin:0 auto; }

  /* COLOUR CODE BANNER */
  .colour-banner {
    border-radius:14px; padding:18px 24px; margin-bottom:24px;
    display:flex; align-items:center; gap:16px;
    border:2px solid;
  }
  .colour-dot { width:40px; height:40px; border-radius:50%; flex-shrink:0; box-shadow:0 0 16px currentColor; }
  .colour-info { flex:1; }
  .colour-title { font-size:16px; font-weight:800; }
  .colour-sub { font-size:13px; opacity:0.8; margin-top:2px; }
  .colour-label { font-family:'Space Mono',monospace; font-size:22px; font-weight:700; }

  /* STATS */
  .stats-row { display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:14px; margin-bottom:24px; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:18px; position:relative; overflow:hidden; }
  .stat-card::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; }
  .stat-card.green::after  { background:var(--accent); }
  .stat-card.gold::after   { background:var(--gold); }
  .stat-card.red::after    { background:var(--danger); }
  .stat-card.warn::after   { background:var(--warning); }
  .stat-card.blue::after   { background:#2255AA; }
  .stat-icon { font-size:22px; margin-bottom:8px; }
  .stat-val { font-family:'Space Mono',monospace; font-size:28px; font-weight:700; line-height:1; }
  .stat-label { font-size:10px; color:var(--muted); letter-spacing:1px; margin-top:4px; text-transform:uppercase; }

  /* TOOLBAR */
  .toolbar { display:flex; align-items:center; gap:12px; margin-bottom:20px; flex-wrap:wrap; }
  .search-wrap { position:relative; flex:1; min-width:200px; }
  .search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); }
  .form-input { width:100%; background:var(--surface2); border:1px solid var(--border2); border-radius:10px; padding:11px 16px; color:var(--text); font-family:'Syne',sans-serif; font-size:14px; transition:border-color 0.2s; }
  .form-input:focus { outline:none; border-color:var(--accent); }
  .search-input { padding-left:36px; }
  .filter-tabs { display:flex; gap:4px; background:var(--surface2); padding:4px; border-radius:10px; border:1px solid var(--border); }
  .filter-tab { padding:6px 14px; border-radius:7px; font-size:11px; font-weight:700; cursor:pointer; color:var(--muted); border:none; background:none; font-family:'Space Mono',monospace; transition:all 0.2s; }
  .filter-tab.active { background:var(--surface); color:var(--text); border:1px solid var(--border2); }

  /* TABLE */
  .table-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; }
  .table-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; font-size:13px; min-width:900px; }
  th { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:2px; padding:12px 16px; text-align:left; border-bottom:1px solid var(--border); white-space:nowrap; }
  td { padding:13px 16px; border-bottom:1px solid var(--border); color:var(--text); vertical-align:middle; }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:rgba(255,255,255,0.02); }
  .mono { font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); }

  /* COLOUR TAG */
  .colour-tag { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:700; font-family:'Space Mono',monospace; }
  .tag-green  { background:rgba(46,125,82,0.2); color:#3a9e68; border:1px solid rgba(46,125,82,0.4); }
  .tag-yellow { background:rgba(201,168,76,0.2); color:#C9A84C; border:1px solid rgba(201,168,76,0.4); }
  .tag-red    { background:rgba(204,51,51,0.2);  color:#CC3333; border:1px solid rgba(204,51,51,0.4); }
  .tag-blue   { background:rgba(34,85,170,0.2);  color:#4477CC; border:1px solid rgba(34,85,170,0.4); }
  .tag-wrong  { background:rgba(255,71,87,0.15); color:var(--danger); border:1px solid rgba(255,71,87,0.3); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

  /* STATUS */
  .badge { display:inline-flex; align-items:center; padding:3px 10px; border-radius:20px; font-size:10px; font-weight:700; letter-spacing:1px; font-family:'Space Mono',monospace; }
  .badge-green  { background:rgba(46,125,82,0.15); color:var(--accent); border:1px solid rgba(46,125,82,0.3); }
  .badge-red    { background:rgba(255,71,87,0.15);  color:var(--danger);  border:1px solid rgba(255,71,87,0.3); }
  .badge-warn   { background:rgba(255,184,0,0.15);  color:var(--warning); border:1px solid rgba(255,184,0,0.3); }
  .badge-muted  { background:rgba(107,122,153,0.15);color:var(--muted);   border:1px solid rgba(107,122,153,0.3); }

  .date-ok   { color:var(--accent); }
  .date-soon { color:var(--warning); font-weight:700; }
  .date-over { color:var(--danger);  font-weight:700; }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px); }
  .modal-box { background:var(--surface); border:1px solid var(--border2); border-radius:18px; padding:28px; max-width:680px; width:100%; max-height:90vh; overflow-y:auto; position:relative; box-shadow:0 32px 80px rgba(0,0,0,0.5); }
  .modal-title { font-size:18px; font-weight:800; margin-bottom:20px; }
  .modal-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--muted); font-size:20px; cursor:pointer; }
  .form-group { margin-bottom:14px; }
  .form-label { display:block; font-size:11px; color:var(--muted); margin-bottom:6px; letter-spacing:1.5px; font-family:'Space Mono',monospace; }
  .form-grid2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .form-grid3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
  .section-label { font-size:12px; font-weight:700; color:var(--accent); letter-spacing:1px; margin:16px 0 10px; text-transform:uppercase; }
  .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }

  .empty { text-align:center; padding:60px 20px; color:var(--muted); }
  .empty .icon { font-size:48px; margin-bottom:12px; display:block; }

  @media (max-width:700px) {
    .stats-row { grid-template-columns:1fr 1fr; }
    .form-grid2, .form-grid3 { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<div class="topbar">
  <a href="index.html" class="back-btn">‚Üê Dashboard</a>
  <div class="topbar-title">ü™ù Lifting Equipment Register</div>
  <div id="role-info" style="font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;"></div>
  <button class="btn btn-primary" id="add-btn" onclick="openAdd()" style="display:none;">+ Add Item</button>
</div>

<div class="content">

  <!-- Colour Code Banner -->
  <div class="colour-banner" id="colour-banner">
    <div class="colour-dot" id="colour-dot"></div>
    <div class="colour-info">
      <div class="colour-title" id="colour-title">Current Quarter Colour Code</div>
      <div class="colour-sub" id="colour-sub"></div>
    </div>
    <div class="colour-label" id="colour-label"></div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card green">
      <div class="stat-icon">ü™ù</div>
      <div class="stat-val" id="s-total">0</div>
      <div class="stat-label">Total Items</div>
    </div>
    <div class="stat-card green">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-val" id="s-correct">0</div>
      <div class="stat-label">Correct Colour</div>
    </div>
    <div class="stat-card gold">
      <div class="stat-icon">üè∑Ô∏è</div>
      <div class="stat-val" id="s-wrong">0</div>
      <div class="stat-label">Wrong Colour</div>
    </div>
    <div class="stat-card warn">
      <div class="stat-icon">‚è∞</div>
      <div class="stat-val" id="s-due">0</div>
      <div class="stat-label">Exam Due Soon</div>
    </div>
    <div class="stat-card red">
      <div class="stat-icon">üö®</div>
      <div class="stat-val" id="s-over">0</div>
      <div class="stat-label">Exam Overdue</div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" class="form-input search-input" id="search-input" placeholder="Search by description, serial, category..." oninput="renderTable()">
    </div>
    <div class="filter-tabs" id="filter-tabs">
      <button class="filter-tab active" data-f="all"     onclick="setFilter('all')">All</button>
      <button class="filter-tab"        data-f="wrong"   onclick="setFilter('wrong')">Wrong Colour</button>
      <button class="filter-tab"        data-f="due"     onclick="setFilter('due')">Due Soon</button>
      <button class="filter-tab"        data-f="overdue" onclick="setFilter('overdue')">Overdue</button>
    </div>
    <button class="btn btn-secondary btn-sm" onclick="printRegister()">üñ®Ô∏è Print Register</button>
  </div>

  <!-- Table -->
  <div class="table-card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>CATEGORY</th>
            <th>DESCRIPTION</th>
            <th>SERIAL No.</th>
            <th>SWL</th>
            <th>COLOUR TAG</th>
            <th>LAST EXAM</th>
            <th>NEXT EXAM DUE</th>
            <th>STATUS</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div id="table-empty" class="empty" style="display:none;">
      <span class="icon">ü™ù</span><strong>No lifting equipment found</strong>
    </div>
  </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal" style="display:none;" onclick="closeModalOutside(event)">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title" id="modal-title">Add Lifting Equipment</div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
let currentFilter = 'all';
let canEdit = false;

const CATEGORIES = ['Crane / Hoist','Chain Sling','Webbing Sling','Wire Rope Sling','Shackle','Hook','Eye Bolt','Beam Clamp','Spreader Beam','Lifting Beam','Chain Block','Come-Along','Load Cell','Other'];
const COLOUR_MAP = { green:'tag-green', yellow:'tag-yellow', red:'tag-red', blue:'tag-blue' };

// ============================================================
function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.toggle('active', t.dataset.f === f));
  renderTable();
}

function daysUntil(dateStr) {
  if (!dateStr) return null;
  return Math.ceil((new Date(dateStr) - new Date()) / 86400000);
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
}

function dateClass(d) {
  const days = daysUntil(d);
  if (days === null) return '';
  if (days < 0) return 'date-over';
  if (days <= 30) return 'date-soon';
  return 'date-ok';
}

// ============================================================
function renderBanner() {
  const qc = DB.getCurrentColourCode();
  const colours = { green:'#2E7D52', yellow:'#C9A84C', red:'#CC3333', blue:'#2255AA' };
  const col = colours[qc.colour];
  const banner = document.getElementById('colour-banner');
  banner.style.borderColor = col + '66';
  banner.style.background = col + '11';
  document.getElementById('colour-dot').style.background = col;
  document.getElementById('colour-dot').style.boxShadow = `0 0 20px ${col}`;
  document.getElementById('colour-title').textContent = `Current Quarter ‚Äî ${qc.label}`;
  document.getElementById('colour-sub').textContent = 'All active lifting equipment must display this colour tag. Wrong tags shown below.';
  document.getElementById('colour-label').textContent = qc.colour.toUpperCase();
  document.getElementById('colour-label').style.color = col;
}

function renderTable() {
  const items = DB.getLiftingItems();
  const qc = DB.getCurrentColourCode();
  const dueAlerts = DB.getLiftingDueAlerts();
  const overdueIds = dueAlerts.filter(a => a.status === 'overdue').map(a => a.id);
  const dueSoonIds = dueAlerts.filter(a => a.status === 'due-soon').map(a => a.id);
  const wrongColour = items.filter(it => it.status==='active' && it.colourCode !== qc.colour).map(it => it.id);

  // Stats
  document.getElementById('s-total').textContent   = items.length;
  document.getElementById('s-correct').textContent = items.filter(it => it.colourCode === qc.colour).length;
  document.getElementById('s-wrong').textContent   = wrongColour.length;
  document.getElementById('s-due').textContent     = dueSoonIds.length;
  document.getElementById('s-over').textContent    = overdueIds.length;

  const q = document.getElementById('search-input').value.toLowerCase();
  let filtered = items;
  if (q) filtered = filtered.filter(it =>
    it.description?.toLowerCase().includes(q) ||
    it.serialNo?.toLowerCase().includes(q) ||
    it.category?.toLowerCase().includes(q) ||
    it.id?.toLowerCase().includes(q) ||
    it.make?.toLowerCase().includes(q)
  );
  if (currentFilter === 'wrong')   filtered = filtered.filter(it => wrongColour.includes(it.id));
  if (currentFilter === 'due')     filtered = filtered.filter(it => dueSoonIds.includes(it.id));
  if (currentFilter === 'overdue') filtered = filtered.filter(it => overdueIds.includes(it.id));

  const tbody = document.getElementById('table-body');
  const empty = document.getElementById('table-empty');

  if (filtered.length === 0) { tbody.innerHTML=''; empty.style.display=''; return; }
  empty.style.display = 'none';

  const colours = { green:'tag-green', yellow:'tag-yellow', red:'tag-red', blue:'tag-blue' };
  const isWrong = id => wrongColour.includes(id);

  tbody.innerHTML = filtered.map(it => {
    const colClass = isWrong(it.id) ? 'tag-wrong' : (colours[it.colourCode] || 'tag-muted');
    const examStatus = overdueIds.includes(it.id) ? `<span class="badge badge-red">üö® OVERDUE</span>` :
                       dueSoonIds.includes(it.id) ? `<span class="badge badge-warn">‚è∞ DUE SOON</span>` :
                                                     `<span class="badge badge-green">‚úì CURRENT</span>`;
    return `<tr>
      <td class="mono">${it.id}</td>
      <td style="font-size:12px;color:var(--muted);">${it.category}</td>
      <td><div style="font-weight:700;">${it.description}</div><div class="mono" style="font-size:10px;">${it.make||''} ${it.model||''}</div></td>
      <td class="mono">${it.serialNo||'‚Äî'}</td>
      <td style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;">${it.swl||'‚Äî'} ${it.swlUnit||'kg'}</td>
      <td>
        <span class="colour-tag ${colClass}">
          ‚óè ${it.colourCode?.toUpperCase()||'‚Äî'}
        </span>
        ${isWrong(it.id) ? `<div style="font-size:10px;color:var(--danger);margin-top:4px;">Should be ${qc.colour.toUpperCase()}</div>` : ''}
      </td>
      <td class="mono ${dateClass(it.lastThoroughExam)}">${fmtDate(it.lastThoroughExam)}</td>
      <td class="mono ${dateClass(it.nextThoroughExam)}">${fmtDate(it.nextThoroughExam)}</td>
      <td>${examStatus}</td>
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          ${canEdit ? `<button class="btn btn-secondary btn-sm" onclick="openEdit('${it.id}')">‚úèÔ∏è</button>` : ''}
          ${canEdit ? `<button class="btn btn-danger btn-sm" onclick="deleteItem('${it.id}')">üóëÔ∏è</button>` : ''}
          <button class="btn btn-secondary btn-sm" onclick="viewItem('${it.id}')">üëÅÔ∏è</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ============================================================
function buildForm(item) {
  const v = (f, def='') => item?.[f] !== undefined ? item[f] : def;
  const colours = ['green','yellow','red','blue'];
  const qc = DB.getCurrentColourCode();

  return `
    <div class="section-label">Item Details</div>
    <div class="form-group"><label class="form-label">CATEGORY *</label>
      <select class="form-input" id="f-cat">
        ${CATEGORIES.map(c => `<option ${v('category')===c?'selected':''}>${c}</option>`).join('')}
      </select>
    </div>
    <div class="form-group"><label class="form-label">DESCRIPTION *</label>
      <input type="text" class="form-input" id="f-desc" value="${v('description')}" placeholder="e.g. 2-Leg Chain Sling 2T">
    </div>
    <div class="form-grid2">
      <div class="form-group"><label class="form-label">MAKE</label><input type="text" class="form-input" id="f-make" value="${v('make')}"></div>
      <div class="form-group"><label class="form-label">MODEL</label><input type="text" class="form-input" id="f-model" value="${v('model')}"></div>
      <div class="form-group"><label class="form-label">SERIAL NUMBER *</label><input type="text" class="form-input" id="f-serial" value="${v('serialNo')}"></div>
      <div class="form-group"><label class="form-label">YEAR OF MANUFACTURE</label><input type="text" class="form-input" id="f-year" value="${v('yearOfManufacture')}" maxlength="4"></div>
    </div>
    <div class="form-grid3">
      <div class="form-group"><label class="form-label">SWL / WLL *</label><input type="number" class="form-input" id="f-swl" value="${v('swl')}" placeholder="2000"></div>
      <div class="form-group"><label class="form-label">UNIT</label>
        <select class="form-input" id="f-swl-unit">
          <option ${v('swlUnit','kg')==='kg'?'selected':''}>kg</option>
          <option ${v('swlUnit')==='t'?'selected':''}>t</option>
          <option ${v('swlUnit')==='kN'?'selected':''}>kN</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">LOCATION</label><input type="text" class="form-input" id="f-loc" value="${v('location')}" placeholder="Rigging Store"></div>
    </div>

    <div class="section-label">Thorough Examination</div>
    <div class="form-grid2">
      <div class="form-group"><label class="form-label">LAST THOROUGH EXAM</label><input type="date" class="form-input" id="f-last-exam" value="${v('lastThoroughExam')}"></div>
      <div class="form-group"><label class="form-label">NEXT EXAM DUE *</label><input type="date" class="form-input" id="f-next-exam" value="${v('nextThoroughExam')}"></div>
      <div class="form-group"><label class="form-label">CERT REFERENCE</label><input type="text" class="form-input" id="f-certref" value="${v('certRef')}"></div>
    </div>

    <div class="section-label">Colour Tag</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;" id="colour-picker">
      ${colours.map(c => {
        const hex = {green:'#2E7D52',yellow:'#C9A84C',red:'#CC3333',blue:'#2255AA'}[c];
        const qLabel = {green:'Q1',yellow:'Q2',red:'Q3',blue:'Q4'}[c];
        const isCurrent = c === qc.colour;
        const isSelected = v('colourCode',qc.colour) === c;
        return `<div onclick="selectColour('${c}')" id="cpick-${c}" style="
          border:2px solid ${isSelected?hex:'var(--border2)'};
          background:${isSelected?hex+'22':'var(--surface2)'};
          border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:all 0.2s;">
          <div style="width:24px;height:24px;border-radius:50%;background:${hex};margin:0 auto 6px;"></div>
          <div style="font-size:11px;font-family:'Space Mono',monospace;font-weight:700;color:${hex};">${c.toUpperCase()}</div>
          <div style="font-size:10px;color:var(--muted);">${qLabel}${isCurrent?' ‚Üê NOW':''}</div>
        </div>`;
      }).join('')}
    </div>
    <input type="hidden" id="f-colour" value="${v('colourCode', qc.colour)}">

    <div class="form-group"><label class="form-label">STATUS</label>
      <select class="form-input" id="f-status">
        <option ${v('status','active')==='active'?'selected':''} value="active">Active</option>
        <option ${v('status')==='retired'?'selected':''} value="retired">Retired / Withdrawn</option>
        <option ${v('status')==='quarantine'?'selected':''} value="quarantine">Quarantine</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">NOTES</label>
      <textarea class="form-input" id="f-notes" rows="2">${v('notes')}</textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn">üíæ Save</button>
    </div>`;
}

let selectedColour = '';
function selectColour(c) {
  selectedColour = c;
  document.getElementById('f-colour').value = c;
  const colours = ['green','yellow','red','blue'];
  const hex = {green:'#2E7D52',yellow:'#C9A84C',red:'#CC3333',blue:'#2255AA'};
  colours.forEach(cc => {
    const el = document.getElementById('cpick-' + cc);
    const h = hex[cc];
    if (cc === c) {
      el.style.borderColor = h; el.style.background = h + '22';
    } else {
      el.style.borderColor = 'var(--border2)'; el.style.background = 'var(--surface2)';
    }
  });
}

function getFormData() {
  return {
    category: document.getElementById('f-cat').value,
    description: document.getElementById('f-desc').value.trim(),
    make: document.getElementById('f-make').value.trim(),
    model: document.getElementById('f-model').value.trim(),
    serialNo: document.getElementById('f-serial').value.trim(),
    yearOfManufacture: document.getElementById('f-year').value.trim(),
    swl: document.getElementById('f-swl').value.trim(),
    swlUnit: document.getElementById('f-swl-unit').value,
    location: document.getElementById('f-loc').value.trim(),
    lastThoroughExam: document.getElementById('f-last-exam').value,
    nextThoroughExam: document.getElementById('f-next-exam').value,
    certRef: document.getElementById('f-certref').value.trim(),
    colourCode: document.getElementById('f-colour').value || DB.getCurrentColourCode().colour,
    status: document.getElementById('f-status').value,
    notes: document.getElementById('f-notes').value.trim(),
  };
}

function openAdd() {
  document.getElementById('modal-title').textContent = '‚ûï Add Lifting Equipment';
  document.getElementById('modal-body').innerHTML = buildForm(null);
  document.getElementById('save-btn').onclick = saveNew;
  document.getElementById('modal').style.display = 'flex';
}

function saveNew() {
  const data = getFormData();
  if (!data.description || !data.nextThoroughExam) { UI.toast('Description and Next Exam date are required','error'); return; }
  DB.addLiftingItem(data);
  UI.toast('Item added to lifting register','success');
  DB.addNotification({ title:'Lifting Item Added', message:`${data.description} added to register by ${AUTH.getSession()?.name}`, type:'info' });
  closeModal(); renderTable();
}

function openEdit(id) {
  const item = DB.getLiftingItem(id);
  document.getElementById('modal-title').textContent = `‚úèÔ∏è Edit ‚Äî ${item.description}`;
  document.getElementById('modal-body').innerHTML = buildForm(item);
  selectedColour = item.colourCode;
  document.getElementById('save-btn').onclick = () => saveEdit(id);
  document.getElementById('modal').style.display = 'flex';
}

function saveEdit(id) {
  const data = getFormData();
  if (!data.description || !data.nextThoroughExam) { UI.toast('Description and Next Exam date are required','error'); return; }
  DB.updateLiftingItem(id, data);
  UI.toast('Item updated','success');
  closeModal(); renderTable();
}

function deleteItem(id) {
  const it = DB.getLiftingItem(id);
  if (!confirm(`Remove ${it.description} from register? This cannot be undone.`)) return;
  DB.deleteLiftingItem(id);
  UI.toast('Item removed from register','warning');
  renderTable();
}

function viewItem(id) {
  const it = DB.getLiftingItem(id);
  const qc = DB.getCurrentColourCode();
  const isWrong = it.colourCode !== qc.colour;
  const hex = {green:'#2E7D52',yellow:'#C9A84C',red:'#CC3333',blue:'#2255AA'}[it.colourCode] || '#666';
  UI.modal(
    `ü™ù ${it.description}`,
    `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
      ${[['ID',it.id],['Category',it.category],['Make / Model',`${it.make||'‚Äî'} ${it.model||''}`],['Serial No.',it.serialNo||'‚Äî'],
         ['SWL',`${it.swl} ${it.swlUnit}`],['Year',it.yearOfManufacture||'‚Äî'],['Location',it.location||'‚Äî'],
         ['Last Exam',fmtDate(it.lastThoroughExam)],['Next Exam Due',fmtDate(it.nextThoroughExam)],['Cert Ref',it.certRef||'‚Äî']
        ].map(([k,v2]) => `<div style="background:var(--surface2);border-radius:10px;padding:12px;">
          <div style="font-size:10px;color:var(--muted);letter-spacing:2px;font-family:'Space Mono',monospace;">${k}</div>
          <div style="font-size:14px;font-weight:700;margin-top:4px;">${v2}</div>
        </div>`).join('')}
    </div>
    <div style="background:${hex}22;border:1px solid ${hex}44;border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px;">
      <div style="width:32px;height:32px;border-radius:50%;background:${hex};flex-shrink:0;"></div>
      <div>
        <div style="font-weight:700;color:${hex};">${it.colourCode?.toUpperCase()} TAG</div>
        <div style="font-size:12px;color:var(--muted);">${isWrong ? `‚ö†Ô∏è Wrong ‚Äî should be ${qc.colour.toUpperCase()} (${qc.label})` : `‚úì Correct for ${qc.label}`}</div>
      </div>
    </div>
    ${it.notes ? `<div style="margin-top:12px;background:rgba(255,183,0,0.08);border:1px solid rgba(255,183,0,0.2);border-radius:8px;padding:10px 14px;font-size:13px;"><strong>Notes:</strong> ${it.notes}</div>` : ''}`
  );
}

// ============================================================
function printRegister() {
  const items = DB.getLiftingItems();
  const settings = DB.getSettings();
  const qc = DB.getCurrentColourCode();
  const today = new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});
  const win = window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>Lifting Register</title>
  <style>
    body{font-family:Arial,sans-serif;margin:30px;font-size:11px;color:#111;}
    h1{font-size:18px;margin-bottom:4px;} .sub{color:#666;margin-bottom:20px;}
    table{width:100%;border-collapse:collapse;margin-top:16px;}
    th{background:#1B5E35;color:white;padding:6px 8px;text-align:left;font-size:9px;letter-spacing:1px;}
    td{padding:6px 8px;border-bottom:1px solid #eee;vertical-align:middle;}
    .header{display:flex;justify-content:space-between;border-bottom:2px solid #1B5E35;padding-bottom:12px;margin-bottom:12px;}
    .company{font-size:16px;font-weight:bold;color:#1B5E35;}
    .overdue{color:#CC0000;font-weight:bold;}
    .due-soon{color:#CC8800;font-weight:bold;}
    .colour-cell{display:flex;align-items:center;gap:6px;}
    .colour-dot{width:12px;height:12px;border-radius:50%;display:inline-block;}
    .footer{margin-top:24px;font-size:9px;color:#999;text-align:center;border-top:1px solid #ddd;padding-top:10px;}
    @media print{button{display:none;}}
  </style></head><body>
  <div class="header">
    <div><div class="company">${settings.companyName}</div><h1>Lifting Equipment Register</h1><div class="sub">Site: ${settings.siteName} ¬∑ Printed: ${today} ¬∑ Current Colour: ${qc.colour.toUpperCase()} (${qc.label})</div></div>
  </div>
  <table>
    <tr><th>ID</th><th>CATEGORY</th><th>DESCRIPTION</th><th>SERIAL</th><th>SWL</th><th>COLOUR</th><th>LAST EXAM</th><th>NEXT EXAM</th><th>CERT REF</th><th>STATUS</th></tr>
    ${items.map(it => {
      const days = it.nextThoroughExam ? Math.ceil((new Date(it.nextThoroughExam)-new Date())/86400000) : null;
      const cls = days===null?'':days<0?'overdue':days<=30?'due-soon':'';
      const colours = {green:'#2E7D52',yellow:'#C9A84C',red:'#CC3333',blue:'#2255AA'};
      return `<tr>
        <td>${it.id}</td><td>${it.category}</td><td><strong>${it.description}</strong><br>${it.make||''} ${it.model||''}</td>
        <td>${it.serialNo||'‚Äî'}</td><td><strong>${it.swl} ${it.swlUnit}</strong></td>
        <td><div class="colour-cell"><span class="colour-dot" style="background:${colours[it.colourCode]||'#666'}"></span>${it.colourCode?.toUpperCase()||'‚Äî'}</div></td>
        <td>${it.lastThoroughExam||'‚Äî'}</td>
        <td class="${cls}">${it.nextThoroughExam||'‚Äî'}${days!==null&&days<0?' (OVERDUE)':days!==null&&days<=30?' (DUE)':''}</td>
        <td>${it.certRef||'‚Äî'}</td><td>${it.status?.toUpperCase()||'ACTIVE'}</td>
      </tr>`;
    }).join('')}
  </table>
  <div class="footer">${settings.companyName} ¬∑ Lifting Equipment Register ¬∑ ¬© 2026 Robert Quinn Ltd ¬∑ All Rights Reserved</div>
  <script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }
function closeModalOutside(e) { if(e.target.id==='modal') closeModal(); }

// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  if (!AUTH.isLoggedIn()) { window.location.href = 'login.html'; return; }
  const role = AUTH.getRole();
  const session = AUTH.getSession();
  canEdit = ['admin','site_manager','safety_officer'].includes(role);
  const ri = AUTH.getRoleInfo();
  document.getElementById('role-info').textContent = `${ri?.icon||''} ${session?.name||''} ¬∑ ${ri?.label||''}`;
  if (canEdit) document.getElementById('add-btn').style.display = '';
  DB.getPlants(); DB.getLiftingItems();
  renderBanner();
  renderTable();
});
</script>
</body>
</html>
