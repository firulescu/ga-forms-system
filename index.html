<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GA Forms System ‚Äî Dashboard</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="js/data.js"></script>
<script src="js/ui.js"></script>
<script src="js/qr.js"></script>
<style>
  :root {
    --bg: #060A14;
    --surface: #0D1421;
    --surface2: #111827;
    --border: #1A2333;
    --border2: #243044;
    --text: #E8EDF5;
    --muted: #6B7A99;
    --accent: #00C896;
    --accent2: #FF6B35;
    --accent3: #7B61FF;
    --danger: #FF4757;
    --warning: #FFB800;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; overflow-x: hidden; }
  
  /* Animated background grid */
  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 0;
    background-image: 
      linear-gradient(rgba(0,200,150,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,200,150,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    animation: gridMove 20s linear infinite;
    pointer-events: none;
  }
  @keyframes gridMove { from { background-position: 0 0; } to { background-position: 60px 60px; } }

  /* ---------- LAYOUT ---------- */
  .app { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; position: relative; z-index: 1; }

  /* ---------- SIDEBAR ---------- */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    position: fixed; top: 0; left: 0; bottom: 0; width: 260px;
    z-index: 100;
  }
  .sidebar-brand {
    padding: 28px 24px 20px;
    border-bottom: 1px solid var(--border);
  }
  .brand-icon { font-size: 32px; margin-bottom: 8px; display: block; }
  .brand-name {
    font-family: 'Space Mono', monospace;
    font-size: 15px; font-weight: 700;
    color: var(--accent);
    letter-spacing: 1px;
  }
  .brand-sub { font-size: 11px; color: var(--muted); letter-spacing: 2px; font-family: 'Space Mono', monospace; }
  
  .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
  .nav-section-label { font-size: 10px; color: var(--muted); letter-spacing: 3px; padding: 16px 12px 8px; font-family: 'Space Mono', monospace; }
  
  .nav-link {
    display: flex; align-items: center; gap: 12px;
    padding: 11px 14px; border-radius: 10px;
    color: var(--muted); font-size: 14px; font-weight: 600;
    text-decoration: none; cursor: pointer;
    transition: all 0.2s; margin-bottom: 2px;
    border: 1px solid transparent;
    position: relative;
  }
  .nav-link:hover { background: var(--surface2); color: var(--text); border-color: var(--border); }
  .nav-link.active { background: rgba(0,200,150,0.1); color: var(--accent); border-color: rgba(0,200,150,0.2); }
  .nav-link .icon { font-size: 18px; width: 22px; text-align: center; }
  .nav-badge {
    margin-left: auto; background: var(--danger); color: white;
    font-size: 10px; font-family: 'Space Mono', monospace; font-weight: 700;
    padding: 2px 7px; border-radius: 20px; min-width: 22px; text-align: center;
  }
  
  .sidebar-footer {
    padding: 16px; border-top: 1px solid var(--border);
  }
  .site-info { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; line-height: 1.6; }
  .site-info strong { color: var(--accent); display: block; }

  /* ---------- MAIN ---------- */
  .main { margin-left: 260px; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
  
  .topbar {
    background: rgba(6,10,20,0.8); backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 16px 32px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 50;
  }
  .page-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
  .topbar-actions { display: flex; align-items: center; gap: 12px; }
  
  .btn {
    font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700;
    padding: 9px 18px; border-radius: 8px; border: none; cursor: pointer;
    transition: all 0.2s; letter-spacing: 0.5px; text-decoration: none;
    display: inline-flex; align-items: center; gap: 7px;
  }
  .btn-primary { background: var(--accent); color: #060A14; }
  .btn-primary:hover { background: #00e8ad; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,200,150,0.4); }
  .btn-secondary { background: transparent; color: var(--muted); border: 1px solid var(--border2); }
  .btn-secondary:hover { background: var(--surface2); color: var(--text); border-color: var(--border2); }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { background: #ff6070; }
  .btn-sm { padding: 6px 12px; font-size: 11px; }

  /* ---------- CONTENT ---------- */
  .content { padding: 32px; flex: 1; }
  .page { display: none; }
  .page.active { display: block; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  /* ---------- STATS GRID ---------- */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 24px; position: relative; overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); border-color: var(--border2); }
  .stat-card::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
  }
  .stat-card.green::after { background: var(--accent); }
  .stat-card.orange::after { background: var(--accent2); }
  .stat-card.purple::after { background: var(--accent3); }
  .stat-card.red::after { background: var(--danger); }
  .stat-icon { font-size: 28px; margin-bottom: 12px; display: block; }
  .stat-value { font-family: 'Space Mono', monospace; font-size: 36px; font-weight: 700; line-height: 1; margin-bottom: 6px; }
  .stat-label { font-size: 12px; color: var(--muted); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
  .stat-sub { font-size: 11px; color: var(--muted); margin-top: 6px; font-family: 'Space Mono', monospace; }

  /* ---------- CARDS ---------- */
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; overflow: hidden;
  }
  .card-header {
    padding: 20px 24px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-title { font-size: 16px; font-weight: 700; }
  .card-body { padding: 24px; }

  /* ---------- PLANT GRID ---------- */
  .plants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
  .plant-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 24px; position: relative; overflow: hidden;
    transition: all 0.25s; cursor: pointer;
  }
  .plant-card:hover { border-color: var(--border2); transform: translateY(-3px); box-shadow: 0 12px 40px rgba(0,0,0,0.3); }
  .plant-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
  .plant-emoji { font-size: 36px; margin-bottom: 8px; display: block; }
  .plant-id { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); letter-spacing: 2px; }
  .plant-name { font-size: 17px; font-weight: 700; margin: 4px 0; }
  .plant-location { font-size: 12px; color: var(--muted); }
  .plant-status { display: flex; align-items: center; gap: 8px; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); font-size: 12px; color: var(--muted); font-family: 'Space Mono', monospace; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .plant-actions { display: flex; gap: 8px; margin-top: 14px; }

  /* ---------- TABLE ---------- */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { 
    font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted);
    letter-spacing: 2px; padding: 12px 16px; text-align: left;
    border-bottom: 1px solid var(--border); white-space: nowrap;
  }
  td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: var(--text); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }
  .mono { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); }

  /* ---------- FORMS ---------- */
  .form-group { margin-bottom: 20px; }
  .form-label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 8px; letter-spacing: 1px; font-family: 'Space Mono', monospace; }
  .form-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 10px; padding: 12px 16px; color: var(--text);
    font-family: 'Syne', sans-serif; font-size: 14px;
    transition: border-color 0.2s;
  }
  .form-input:focus { outline: none; border-color: var(--accent); }
  .form-select { appearance: none; cursor: pointer; }

  /* ---------- COMPLIANCE GAUGE ---------- */
  .compliance-row { display: flex; align-items: center; gap: 16px; margin-bottom: 10px; }
  .compliance-bar-wrap { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .compliance-bar { height: 100%; border-radius: 4px; transition: width 1s ease; }

  /* ---------- QR MODAL ---------- */
  #qr-render { display: flex; justify-content: center; margin: 16px 0; }
  #qr-render img { border-radius: 8px; }
  #qr-render canvas { border-radius: 8px; }

  /* ---------- NOTIFICATION DOT ---------- */
  .notif-dot {
    width: 8px; height: 8px; background: var(--danger); border-radius: 50%;
    position: absolute; top: 8px; right: 10px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.6;transform:scale(1.2);} }

  /* ---------- GRID LAYOUTS ---------- */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  .three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; }

  /* ---------- EMPTY STATE ---------- */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; display: block; }
  .empty-state p { font-size: 14px; margin-top: 8px; }

  /* ---------- SCROLLABLE LIST ---------- */
  .scroll-list { max-height: 320px; overflow-y: auto; }
  .list-item {
    display: flex; align-items: center; gap: 14px; padding: 14px 0;
    border-bottom: 1px solid var(--border);
  }
  .list-item:last-child { border-bottom: none; }

  /* ---------- SEARCH ---------- */
  .search-bar { position: relative; }
  .search-bar input { padding-left: 36px; }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; }

  /* ---------- RESPONSIVE ---------- */
  @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 900px) {
    .app { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    .main { margin-left: 0; }
    .two-col, .three-col { grid-template-columns: 1fr; }
  }

  /* ---------- SWITCH TOGGLE ---------- */
  .switch { position: relative; display: inline-flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; color: var(--muted); }
  .switch input { display: none; }
  .switch-track { width: 40px; height: 22px; background: var(--border2); border-radius: 11px; position: relative; transition: background 0.2s; }
  .switch input:checked + .switch-track { background: var(--accent); }
  .switch-track::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: transform 0.2s; }
  .switch input:checked + .switch-track::after { transform: translateX(18px); }

  /* ---------- CHART BAR ---------- */
  .mini-chart { display: flex; align-items: flex-end; gap: 4px; height: 60px; margin-top: 8px; }
  .mini-bar { flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; opacity: 0.7; min-height: 4px; transition: opacity 0.2s; }
  .mini-bar:hover { opacity: 1; }

  /* ---------- FILTER TABS ---------- */
  .filter-tabs { display: flex; gap: 4px; background: var(--surface2); padding: 4px; border-radius: 10px; border: 1px solid var(--border); }
  .filter-tab { padding: 7px 16px; border-radius: 7px; font-size: 12px; font-weight: 700; cursor: pointer; color: var(--muted); border: none; background: none; font-family: 'Space Mono', monospace; transition: all 0.2s; }
  .filter-tab.active { background: var(--surface); color: var(--text); border: 1px solid var(--border2); }
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <span class="brand-icon">üõ°Ô∏è</span>
      <div class="brand-name">GA FORMS</div>
      <div class="brand-sub">SAFETY SYSTEM</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">OVERVIEW</div>
      <a class="nav-link active" data-page="dashboard" onclick="showPage('dashboard')">
        <span class="icon">üìä</span> Dashboard
      </a>
      <a class="nav-link" data-page="compliance" onclick="showPage('compliance')">
        <span class="icon">‚úÖ</span> Compliance
        <span class="nav-badge" id="issues-badge" style="display:none">0</span>
      </a>
      <div class="nav-section-label">PLANT</div>
      <a class="nav-link" data-page="plants" onclick="showPage('plants')">
        <span class="icon">üèóÔ∏è</span> Plant Register
      </a>
      <a class="nav-link" data-page="qr-codes" onclick="showPage('qr-codes')">
        <span class="icon">üì±</span> QR Codes
      </a>
      <div class="nav-section-label">FORMS</div>
      <a class="nav-link" data-page="submissions" onclick="showPage('submissions')">
        <span class="icon">üìã</span> Submissions
      </a>
      <a class="nav-link" data-page="form-templates" onclick="showPage('form-templates')">
        <span class="icon">üìù</span> Form Templates
      </a>
      <div class="nav-section-label">SYSTEM</div>
      <a class="nav-link" data-page="notifications" onclick="showPage('notifications')" style="position:relative;">
        <span class="icon">üîî</span> Notifications
        <span class="nav-badge" id="notif-badge" style="display:none">0</span>
      </a>
      <a class="nav-link" data-page="settings" onclick="showPage('settings')">
        <span class="icon">‚öôÔ∏è</span> Settings
      </a>
    </nav>
    <div class="sidebar-footer">
      <div class="site-info">
        <strong id="site-name-display">Loading...</strong>
        <span id="company-display">Loading...</span>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <div class="topbar">
      <div class="page-title" id="page-title">Dashboard</div>
      <div class="topbar-actions">
        <span id="current-date" class="mono" style="font-size:12px;"></span>
        <button class="btn btn-primary" onclick="window.open('form.html','_blank')">+ New Form</button>
      </div>
    </div>

    <div class="content">

      <!-- ===== DASHBOARD PAGE ===== -->
      <div class="page active" id="page-dashboard">
        <div class="stats-grid">
          <div class="stat-card green">
            <span class="stat-icon">üèóÔ∏è</span>
            <div class="stat-value" id="stat-plants">0</div>
            <div class="stat-label">Total Plants</div>
            <div class="stat-sub">On register</div>
          </div>
          <div class="stat-card orange">
            <span class="stat-icon">üìã</span>
            <div class="stat-value" id="stat-weekly">0</div>
            <div class="stat-label">Forms This Week</div>
            <div class="stat-sub">Last 7 days</div>
          </div>
          <div class="stat-card purple">
            <span class="stat-icon">‚úÖ</span>
            <div class="stat-value" id="stat-compliant">0</div>
            <div class="stat-label">Compliant Plants</div>
            <div class="stat-sub">Inspected today</div>
          </div>
          <div class="stat-card red">
            <span class="stat-icon">‚ö†Ô∏è</span>
            <div class="stat-value" id="stat-issues">0</div>
            <div class="stat-label">Open Issues</div>
            <div class="stat-sub">Need attention</div>
          </div>
        </div>

        <div class="two-col" style="margin-bottom:24px;">
          <div class="card">
            <div class="card-header">
              <span class="card-title">Recent Submissions</span>
              <button class="btn btn-secondary btn-sm" onclick="showPage('submissions')">View All</button>
            </div>
            <div id="recent-submissions-list" class="scroll-list" style="padding:0 24px;">
              <div class="empty-state"><span class="icon">üì≠</span><strong>No submissions yet</strong><p>Forms submitted from the field will appear here</p></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title">Plant Status Overview</span>
            </div>
            <div class="card-body" id="plant-status-overview"></div>
          </div>
        </div>

        <div class="two-col">
          <div class="card">
            <div class="card-header"><span class="card-title">‚ö†Ô∏è Compliance Alerts</span></div>
            <div id="compliance-alerts" class="scroll-list" style="padding:0 24px;">
              <div class="empty-state"><span class="icon">üéâ</span><strong>All clear!</strong><p>No compliance issues detected</p></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">üìÖ Submissions This Week</span></div>
            <div class="card-body">
              <div class="mini-chart" id="week-chart"></div>
              <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--muted);font-family:'Space Mono',monospace;" id="week-labels"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== PLANTS PAGE ===== -->
      <div class="page" id="page-plants">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <div>
            <div style="font-size:13px;color:var(--muted);margin-top:4px;" id="plant-count-label"></div>
          </div>
          <div style="display:flex;gap:10px;">
            <div class="search-bar">
              <span class="search-icon">üîç</span>
              <input type="text" class="form-input" id="plant-search" placeholder="Search plants..." oninput="filterPlants()" style="width:220px;">
            </div>
            <button class="btn btn-primary" onclick="openAddPlantModal()">+ Add Plant</button>
          </div>
        </div>
        <div class="plants-grid" id="plants-grid"></div>
      </div>

      <!-- ===== QR CODES PAGE ===== -->
      <div class="page" id="page-qr-codes">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <div style="font-size:13px;color:var(--muted);">Click any QR code to view, download or print the label</div>
          <button class="btn btn-secondary" onclick="printAllLabels()">üñ®Ô∏è Print All Labels</button>
        </div>
        <div id="qr-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;"></div>
      </div>

      <!-- ===== SUBMISSIONS PAGE ===== -->
      <div class="page" id="page-submissions">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
          <div style="display:flex;gap:10px;align-items:center;">
            <div class="filter-tabs" id="form-filter-tabs">
              <button class="filter-tab active" data-filter="ALL" onclick="filterSubmissions('ALL')">ALL</button>
              <button class="filter-tab" data-filter="GA2" onclick="filterSubmissions('GA2')">GA2</button>
              <button class="filter-tab" data-filter="GA3" onclick="filterSubmissions('GA3')">GA3</button>
              <button class="filter-tab" data-filter="GA4" onclick="filterSubmissions('GA4')">GA4</button>
            </div>
          </div>
          <div class="search-bar">
            <span class="search-icon">üîç</span>
            <input type="text" class="form-input" id="sub-search" placeholder="Search by name, plant..." oninput="filterSubmissionsText()" style="width:260px;">
          </div>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table id="submissions-table">
              <thead>
                <tr>
                  <th>FORM</th>
                  <th>PLANT</th>
                  <th>OPERATOR</th>
                  <th>COMPANY</th>
                  <th>SUBMITTED</th>
                  <th>SCORE</th>
                  <th>STATUS</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody id="submissions-tbody"></tbody>
            </table>
          </div>
          <div id="submissions-empty" class="empty-state" style="display:none;">
            <span class="icon">üì≠</span><strong>No submissions found</strong><p>Submitted forms will appear here</p>
          </div>
        </div>
      </div>

      <!-- ===== FORM TEMPLATES PAGE ===== -->
      <div class="page" id="page-form-templates">
        <div style="margin-bottom:24px;">
          <div style="font-size:13px;color:var(--muted);">Manage form checklists. Templates define what operators see when filling a form.</div>
        </div>
        <div id="templates-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:24px;"></div>
      </div>

      <!-- ===== COMPLIANCE PAGE ===== -->
      <div class="page" id="page-compliance">
        <div class="card" style="margin-bottom:24px;">
          <div class="card-header"><span class="card-title">üìä Overall Compliance Rate</span></div>
          <div class="card-body" id="compliance-overview"></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">‚ö†Ô∏è Issues Log</span></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>PLANT</th><th>ISSUE</th><th>SEVERITY</th><th>ACTION</th></tr></thead>
              <tbody id="compliance-table"></tbody>
            </table>
          </div>
          <div id="compliance-empty" class="empty-state" style="display:none;">
            <span class="icon">üéâ</span><strong>100% Compliant!</strong><p>All plants have completed their required inspections</p>
          </div>
        </div>
      </div>

      <!-- ===== NOTIFICATIONS PAGE ===== -->
      <div class="page" id="page-notifications">
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <div style="font-size:13px;color:var(--muted);">System alerts and compliance notifications</div>
          <button class="btn btn-secondary btn-sm" onclick="markAllRead()">Mark all read</button>
        </div>
        <div class="card">
          <div id="notif-list" style="padding:0 24px;"></div>
        </div>
      </div>

      <!-- ===== SETTINGS PAGE ===== -->
      <div class="page" id="page-settings">
        <div class="two-col">
          <div class="card">
            <div class="card-header"><span class="card-title">üè¢ Site Configuration</span></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">COMPANY NAME</label>
                <input type="text" class="form-input" id="set-company" placeholder="Your company name">
              </div>
              <div class="form-group">
                <label class="form-label">SITE NAME</label>
                <input type="text" class="form-input" id="set-site" placeholder="Site name">
              </div>
              <div class="form-group">
                <label class="form-label">SITE MANAGER</label>
                <input type="text" class="form-input" id="set-manager" placeholder="Manager name">
              </div>
              <div class="form-group">
                <label class="form-label">SAFETY OFFICER</label>
                <input type="text" class="form-input" id="set-safety" placeholder="Safety officer name">
              </div>
              <div class="form-group">
                <label class="form-label">NOTIFICATION EMAIL</label>
                <input type="email" class="form-input" id="set-email" placeholder="safety@company.com">
              </div>
              <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
          </div>
          <div>
            <div class="card" style="margin-bottom:20px;">
              <div class="card-header"><span class="card-title">üîÑ Inspection Requirements</span></div>
              <div class="card-body">
                <div class="form-group">
                  <label class="form-label">REQUIRED DAILY FORM</label>
                  <select class="form-input form-select" id="set-daily">
                    <option value="GA2">GA2 - Pre-Start Inspection</option>
                    <option value="GA3">GA3 - Hazard Assessment</option>
                    <option value="GA4">GA4 - Maintenance Check</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">REQUIRED WEEKLY FORM</label>
                  <select class="form-input form-select" id="set-weekly">
                    <option value="GA3">GA3 - Hazard Assessment</option>
                    <option value="GA2">GA2 - Pre-Start Inspection</option>
                    <option value="GA4">GA4 - Maintenance Check</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><span class="card-title">üóëÔ∏è Data Management</span></div>
              <div class="card-body">
                <p style="color:var(--muted);font-size:13px;margin-bottom:16px;">Export or reset system data. Use with caution.</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                  <button class="btn btn-secondary btn-sm" onclick="exportData()">üì§ Export JSON</button>
                  <button class="btn btn-secondary btn-sm" onclick="importDataPrompt()">üì• Import JSON</button>
                  <button class="btn btn-danger btn-sm" onclick="resetData()">‚ö†Ô∏è Reset All Data</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </main>
</div>

<script>
// ============================================================
// NAVIGATION
// ============================================================
const pageTitles = {
  dashboard: 'üìä Dashboard',
  plants: 'üèóÔ∏è Plant Register',
  'qr-codes': 'üì± QR Codes',
  submissions: 'üìã Submissions',
  'form-templates': 'üìù Form Templates',
  compliance: '‚úÖ Compliance',
  notifications: 'üîî Notifications',
  settings: '‚öôÔ∏è Settings',
};

function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelector(`[data-page="${page}"]`).classList.add('active');
  document.getElementById('page-title').textContent = pageTitles[page] || page;
  const renders = { dashboard: renderDashboard, plants: renderPlants, 'qr-codes': renderQRCodes, submissions: renderSubmissions, 'form-templates': renderTemplates, compliance: renderCompliance, notifications: renderNotifications, settings: renderSettings };
  if (renders[page]) renders[page]();
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const plants = DB.getPlants();
  const weekSubs = DB.getSubmissionsThisWeek();
  const allSubs = DB.getSubmissions();
  const today = new Date().toDateString();
  const compliantToday = plants.filter(p => p.lastInspected && new Date(p.lastInspected).toDateString() === today).length;
  const issues = DB.checkCompliance();

  // Animate stats
  ['stat-plants', 'stat-weekly', 'stat-compliant', 'stat-issues'].forEach((id, i) => {
    const vals = [plants.length, weekSubs.length, compliantToday, issues.length];
    UI.animateCounter(document.getElementById(id), vals[i]);
  });

  // Badge
  const b = document.getElementById('issues-badge');
  if (issues.length > 0) { b.style.display = ''; b.textContent = issues.length; } else { b.style.display = 'none'; }

  // Recent submissions
  const rsList = document.getElementById('recent-submissions-list');
  if (allSubs.length === 0) {
    rsList.innerHTML = `<div class="empty-state"><span class="icon">üì≠</span><strong>No submissions yet</strong><p>Forms submitted from the field will appear here</p></div>`;
  } else {
    rsList.innerHTML = allSubs.slice(0, 8).map(s => {
      const plant = DB.getPlant(s.plantId);
      const score = Math.round((s.passed / s.total) * 100);
      const color = score >= 80 ? '#00C896' : score >= 60 ? '#FF6B35' : '#FF4757';
      return `<div class="list-item">
        <span style="font-size:24px;">${plant?.photo || 'üèóÔ∏è'}</span>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${s.formId} ‚Äî ${plant?.name || s.plantId}</div>
          <div class="mono" style="font-size:11px;">${s.operatorName} ¬∑ ${UI.timeAgo(s.submittedAt)}</div>
        </div>
        <div style="font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:${color};">${score}%</div>
      </div>`;
    }).join('');
  }

  // Plant status overview
  const overview = document.getElementById('plant-status-overview');
  overview.innerHTML = plants.slice(0, 6).map(p => {
    const color = UI.complianceColor(p);
    const label = UI.complianceLabel(p);
    return `<div class="compliance-row">
      <span style="width:26px;font-size:16px;">${p.photo}</span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.name}</div>
        <div class="compliance-bar-wrap">
          <div class="compliance-bar" style="width:${label==='COMPLIANT'?100:label==='NEEDS ATTENTION'?50:15}%;background:${color};"></div>
        </div>
      </div>
      <span style="font-family:'Space Mono',monospace;font-size:10px;color:${color};white-space:nowrap;">${label}</span>
    </div>`;
  }).join('');

  // Compliance alerts
  const alerts = document.getElementById('compliance-alerts');
  if (issues.length === 0) {
    alerts.innerHTML = `<div class="empty-state"><span class="icon">üéâ</span><strong>All clear!</strong><p>No compliance issues detected</p></div>`;
  } else {
    alerts.innerHTML = issues.slice(0, 6).map(i => `
      <div class="list-item">
        <span style="color:${i.severity==='warning'?'#FFB800':'#6B7A99'};font-size:18px;">${i.severity==='warning'?'‚ö†Ô∏è':'‚ÑπÔ∏è'}</span>
        <div style="flex:1;">
          <div style="font-size:13px;font-weight:700;">${i.plantName}</div>
          <div class="mono" style="font-size:11px;color:var(--muted);">${i.issue}</div>
        </div>
      </div>`).join('');
  }

  // Week chart
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const today2 = new Date();
  const weekData = days.map((d, i) => {
    const date = new Date(today2);
    date.setDate(today2.getDate() - (6 - i));
    const ds = date.toDateString();
    return allSubs.filter(s => new Date(s.submittedAt).toDateString() === ds).length;
  });
  const maxVal = Math.max(...weekData, 1);
  document.getElementById('week-chart').innerHTML = weekData.map((v, i) => `
    <div class="mini-bar" title="${days[i]}: ${v} submissions" style="height:${(v/maxVal)*100}%;background:${i===6?'var(--accent)':'rgba(0,200,150,0.4)'};">
    </div>`).join('');
  document.getElementById('week-labels').innerHTML = days.map(d => `<span>${d}</span>`).join('');
}

// ============================================================
// PLANTS
// ============================================================
let allPlants = [];
function renderPlants() {
  allPlants = DB.getPlants();
  document.getElementById('plant-count-label').textContent = `${allPlants.length} plant${allPlants.length !== 1 ? 's' : ''} on register`;
  renderPlantCards(allPlants);
}

function renderPlantCards(plants) {
  const grid = document.getElementById('plants-grid');
  if (plants.length === 0) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><span class="icon">üèóÔ∏è</span><strong>No plants found</strong><p>Add your first plant to get started</p></div>`;
    return;
  }
  grid.innerHTML = plants.map(p => {
    const color = UI.complianceColor(p);
    const label = UI.complianceLabel(p);
    const subs = DB.getSubmissionsForPlant(p.id);
    return `<div class="plant-card" onclick="viewPlant('${p.id}')">
      <div class="plant-card-header">
        <div>
          <span class="plant-emoji">${p.photo || 'üèóÔ∏è'}</span>
          <div class="plant-id">${p.id}</div>
          <div class="plant-name">${p.name}</div>
          <div class="plant-location">üìç ${p.location}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          ${UI.badge(p.type, '#7B61FF')}
          <div style="width:10px;height:10px;border-radius:50%;background:${color};box-shadow:0 0 8px ${color};margin-top:4px;"></div>
        </div>
      </div>
      <div class="plant-status">
        <div class="status-dot" style="background:${color};box-shadow:0 0 6px ${color};"></div>
        <span style="color:${color};font-weight:700;">${label}</span>
        <span style="margin-left:auto;">Last: ${UI.timeAgo(p.lastInspected)}</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px;font-family:'Space Mono',monospace;">${subs.length} submission${subs.length !== 1 ? 's' : ''}</div>
      <div class="plant-actions" onclick="event.stopPropagation()">
        <a href="form.html?plant=${p.id}" target="_blank" class="btn btn-primary btn-sm">üìã Fill Form</a>
        <button class="btn btn-secondary btn-sm" onclick="showQR('${p.id}')">üì± QR</button>
        <button class="btn btn-secondary btn-sm" onclick="editPlant('${p.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="deletePlant('${p.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

function filterPlants() {
  const q = document.getElementById('plant-search').value.toLowerCase();
  renderPlantCards(allPlants.filter(p =>
    p.name.toLowerCase().includes(q) ||
    p.id.toLowerCase().includes(q) ||
    p.location.toLowerCase().includes(q) ||
    p.type.toLowerCase().includes(q)
  ));
}

function viewPlant(id) {
  const plant = DB.getPlant(id);
  const subs = DB.getSubmissionsForPlant(id);
  const color = UI.complianceColor(plant);
  const histHTML = subs.length === 0 ? '<p style="color:var(--muted);">No submissions for this plant yet.</p>' :
    subs.slice(0, 10).map(s => {
      const score = Math.round((s.passed / s.total) * 100);
      const c = score >= 80 ? '#00C896' : score >= 60 ? '#FF6B35' : '#FF4757';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
        <div><div style="font-size:13px;font-weight:700;">${s.formId}</div><div style="font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;">${s.operatorName} ¬∑ ${UI.formatDate(s.submittedAt)}</div></div>
        <div style="color:${c};font-family:'Space Mono',monospace;font-weight:700;">${score}%</div>
      </div>`;
    }).join('');
  UI.modal(
    `${plant.photo} ${plant.name}`,
    `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
      <div style="background:var(--surface2);border-radius:10px;padding:14px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;font-family:'Space Mono',monospace;">PLANT ID</div>
        <div style="font-size:16px;font-weight:700;margin-top:4px;">${plant.id}</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:14px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;font-family:'Space Mono',monospace;">STATUS</div>
        <div style="font-size:16px;font-weight:700;color:${color};margin-top:4px;">${UI.complianceLabel(plant)}</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:14px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;font-family:'Space Mono',monospace;">LOCATION</div>
        <div style="font-size:14px;margin-top:4px;">${plant.location}</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:14px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;font-family:'Space Mono',monospace;">TYPE</div>
        <div style="font-size:14px;margin-top:4px;">${plant.type}</div>
      </div>
    </div>
    <div style="font-size:14px;font-weight:700;margin-bottom:12px;color:var(--text);">üìã Inspection History</div>
    ${histHTML}`,
    `<a href="form.html?plant=${plant.id}" target="_blank" class="btn btn-primary">+ Fill Form</a>`
  );
}

function openAddPlantModal(existing = null) {
  const plant = existing || { id: '', name: '', location: '', type: 'Generator', photo: '‚ö°' };
  const types = ['Generator', 'Compressor', 'Lifting', 'Mobile Plant', 'Pressure Vessel', 'Elevated Work', 'Pump', 'Conveyor', 'Other'];
  const emojis = ['‚ö°','üí®','üèóÔ∏è','üöõ','üîµ','üîº','‚öôÔ∏è','üîß','üè≠','üõ¢Ô∏è'];
  UI.modal(
    existing ? '‚úèÔ∏è Edit Plant' : '‚ûï Add New Plant',
    `<div class="form-group">
      <label class="form-label">PLANT NAME</label>
      <input type="text" class="form-input" id="mp-name" value="${plant.name}" placeholder="e.g. Diesel Generator A">
    </div>
    <div class="form-group">
      <label class="form-label">LOCATION ON SITE</label>
      <input type="text" class="form-input" id="mp-location" value="${plant.location}" placeholder="e.g. Building 1 - Basement">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group">
        <label class="form-label">PLANT TYPE</label>
        <select class="form-input form-select" id="mp-type">
          ${types.map(t => `<option ${t===plant.type?'selected':''}>${t}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ICON</label>
        <select class="form-input form-select" id="mp-emoji">
          ${emojis.map(e => `<option ${e===plant.photo?'selected':''}>${e}</option>`).join('')}
        </select>
      </div>
    </div>`,
    `<button onclick="UI.closeModal()" style="${UI.btnStyle('secondary')}">Cancel</button>
     <button onclick="savePlant('${plant.id}')" style="${UI.btnStyle('primary')}">${existing ? 'Save Changes' : 'Add Plant'}</button>`
  );
}

function savePlant(existingId) {
  const name = document.getElementById('mp-name').value.trim();
  const location = document.getElementById('mp-location').value.trim();
  const type = document.getElementById('mp-type').value;
  const photo = document.getElementById('mp-emoji').value;
  if (!name || !location) { UI.toast('Please fill in all fields', 'error'); return; }
  if (existingId) {
    DB.updatePlant(existingId, { name, location, type, photo });
    UI.toast('Plant updated', 'success');
  } else {
    const p = DB.addPlant({ name, location, type, photo });
    DB.addNotification({ title: 'Plant Added', message: `${name} added to register`, type: 'info' });
    UI.toast('Plant added to register', 'success');
  }
  UI.closeModal();
  renderPlants();
}

function editPlant(id) {
  openAddPlantModal(DB.getPlant(id));
}

function deletePlant(id) {
  const p = DB.getPlant(id);
  UI.confirm(`Delete <strong>${p.name}</strong>? This will also remove all associated submissions.`, () => {
    DB.deletePlant(id);
    UI.toast('Plant deleted', 'warning');
    renderPlants();
  });
}

// ============================================================
// QR CODES
// ============================================================
function renderQRCodes() {
  const plants = DB.getPlants();
  const grid = document.getElementById('qr-grid');
  grid.innerHTML = plants.map(p => `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s;"
         onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'"
         onclick="showQR('${p.id}')">
      <div id="qr-mini-${p.id}" style="display:flex;justify-content:center;margin-bottom:12px;"></div>
      <div style="font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;">${p.id}</div>
      <div style="font-size:14px;font-weight:700;margin:4px 0;">${p.photo} ${p.name}</div>
      <div style="font-size:11px;color:var(--muted);">üìç ${p.location}</div>
      <button onclick="event.stopPropagation();QRGen.printLabel(DB.getPlant('${p.id}'))" class="btn btn-secondary btn-sm" style="margin-top:12px;width:100%;">üñ®Ô∏è Print Label</button>
    </div>`).join('');

  // Render QR codes
  setTimeout(() => {
    plants.forEach(p => {
      const el = document.getElementById('qr-mini-' + p.id);
      if (el) QRGen.renderToCanvas(p.id, el);
    });
  }, 100);
}

function showQR(plantId) {
  const plant = DB.getPlant(plantId);
  UI.modal(
    `üì± QR Code ‚Äî ${plant.name}`,
    `<p style="color:var(--muted);font-size:13px;margin-bottom:16px;">Scan this code to open the inspection form directly on your mobile device.</p>
     <div id="qr-render" style="display:flex;justify-content:center;padding:20px;background:white;border-radius:12px;margin-bottom:16px;"></div>
     <div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);text-align:center;word-break:break-all;" id="qr-url-display"></div>`,
    `<button onclick="QRGen.printLabel(DB.getPlant('${plantId}'));UI.closeModal();" style="${UI.btnStyle('primary')}">üñ®Ô∏è Print Label</button>`
  );
  setTimeout(() => {
    const url = QRGen.renderToCanvas(plantId, document.getElementById('qr-render'));
    const urlEl = document.getElementById('qr-url-display');
    if (urlEl && url) urlEl.textContent = url;
  }, 100);
}

function printAllLabels() {
  DB.getPlants().forEach((p, i) => setTimeout(() => QRGen.printLabel(p), i * 300));
}

// ============================================================
// SUBMISSIONS
// ============================================================
let subFilter = 'ALL';
function renderSubmissions() {
  filterSubmissions(subFilter);
}

function filterSubmissions(filter) {
  subFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.toggle('active', t.dataset.filter === filter));
  let subs = DB.getSubmissions();
  if (filter !== 'ALL') subs = subs.filter(s => s.formId === filter);
  const q = document.getElementById('sub-search')?.value?.toLowerCase() || '';
  if (q) subs = subs.filter(s => s.operatorName?.toLowerCase().includes(q) || s.companyName?.toLowerCase().includes(q) || s.plantId?.toLowerCase().includes(q));
  renderSubmissionTable(subs);
}

function filterSubmissionsText() { filterSubmissions(subFilter); }

function renderSubmissionTable(subs) {
  const tbody = document.getElementById('submissions-tbody');
  const empty = document.getElementById('submissions-empty');
  if (subs.length === 0) { tbody.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';
  tbody.innerHTML = subs.map(s => {
    const plant = DB.getPlant(s.plantId);
    const score = Math.round((s.passed / s.total) * 100);
    const color = score >= 80 ? '#00C896' : score >= 60 ? '#FF6B35' : '#FF4757';
    const status = score === 100 ? 'PASS' : score >= 80 ? 'PASS' : score >= 60 ? 'PARTIAL' : 'FAIL';
    const statusColor = status === 'PASS' ? '#00C896' : status === 'PARTIAL' ? '#FF6B35' : '#FF4757';
    return `<tr>
      <td>${UI.badge(s.formId, '#7B61FF')}</td>
      <td><div style="font-weight:700;font-size:13px;">${plant?.photo || ''} ${plant?.name || s.plantId}</div><div class="mono" style="font-size:10px;">${s.plantId}</div></td>
      <td><div style="font-weight:600;">${s.operatorName}</div></td>
      <td class="mono" style="font-size:11px;">${s.companyName || '‚Äî'}</td>
      <td class="mono" style="font-size:11px;">${UI.formatDate(s.submittedAt)}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:60px;height:6px;background:var(--border);border-radius:3px;overflow:hidden;">
            <div style="width:${score}%;height:100%;background:${color};border-radius:3px;"></div>
          </div>
          <span style="color:${color};font-family:'Space Mono',monospace;font-size:12px;font-weight:700;">${score}%</span>
        </div>
      </td>
      <td>${UI.badge(status, statusColor)}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="viewSubmission('${s.id}')">üëÅÔ∏è View</button></td>
    </tr>`;
  }).join('');
}

function viewSubmission(id) {
  const s = DB.getSubmissions().find(s => s.id === id);
  if (!s) return;
  const plant = DB.getPlant(s.plantId);
  const template = DB.getFormTemplate(s.formId);
  const score = Math.round((s.passed / s.total) * 100);
  const color = score >= 80 ? '#00C896' : score >= 60 ? '#FF6B35' : '#FF4757';
  
  let sectionsHTML = '';
  if (template && s.answers) {
    let answerIdx = 0;
    template.sections.forEach(sec => {
      sectionsHTML += `<div style="margin-bottom:16px;"><div style="font-size:12px;font-weight:700;color:var(--accent);letter-spacing:1px;margin-bottom:8px;">${sec.title.toUpperCase()}</div>`;
      sec.items.forEach(item => {
        const ans = s.answers[answerIdx] || false;
        sectionsHTML += `<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;">
          <span style="color:${ans?'#00C896':'#FF4757'};font-size:16px;flex-shrink:0;">${ans?'‚úì':'‚úï'}</span>
          <span style="color:${ans?'var(--text)':'var(--muted)'};">${item}</span>
        </div>`;
        answerIdx++;
      });
      sectionsHTML += `</div>`;
    });
  }

  UI.modal(
    `${s.formId} ‚Äî ${plant?.name || s.plantId}`,
    `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;">
      <div style="background:var(--surface2);border-radius:10px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;">SCORE</div>
        <div style="font-size:28px;font-weight:700;color:${color};font-family:'Space Mono',monospace;">${score}%</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:12px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;">OPERATOR</div>
        <div style="font-size:13px;font-weight:700;margin-top:4px;">${s.operatorName}</div>
        <div style="font-size:11px;color:var(--muted);">${s.companyName}</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:12px;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;">SUBMITTED</div>
        <div style="font-size:12px;font-weight:700;margin-top:4px;font-family:'Space Mono',monospace;">${UI.formatDate(s.submittedAt)}</div>
      </div>
    </div>
    ${s.notes ? `<div style="background:rgba(255,183,0,0.1);border:1px solid rgba(255,183,0,0.3);border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;"><strong>üìù Notes:</strong> ${s.notes}</div>` : ''}
    <div style="max-height:300px;overflow-y:auto;">${sectionsHTML}</div>`
  );
}

// ============================================================
// TEMPLATES
// ============================================================
function renderTemplates() {
  const templates = DB.getFormTemplates();
  document.getElementById('templates-grid').innerHTML = templates.map(t => {
    const totalItems = t.sections.reduce((sum, s) => sum + s.items.length, 0);
    return `<div class="card">
      <div class="card-header" style="border-bottom-color:${t.color}44;">
        <div>
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-family:'Space Mono',monospace;font-size:18px;font-weight:700;color:${t.color};">${t.id}</span>
            ${UI.badge('ACTIVE', t.color)}
          </div>
          <div style="font-size:16px;font-weight:700;margin-top:4px;">${t.name}</div>
        </div>
      </div>
      <div class="card-body">
        <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">${t.description}</p>
        <div style="display:flex;gap:12px;margin-bottom:16px;">
          <div style="text-align:center;background:var(--surface2);border-radius:10px;padding:10px 16px;">
            <div style="font-family:'Space Mono',monospace;font-size:22px;font-weight:700;color:${t.color};">${t.sections.length}</div>
            <div style="font-size:10px;color:var(--muted);">SECTIONS</div>
          </div>
          <div style="text-align:center;background:var(--surface2);border-radius:10px;padding:10px 16px;">
            <div style="font-family:'Space Mono',monospace;font-size:22px;font-weight:700;color:${t.color};">${totalItems}</div>
            <div style="font-size:10px;color:var(--muted);">ITEMS</div>
          </div>
        </div>
        <div style="margin-bottom:16px;">
          ${t.sections.map(s => `<div style="font-size:12px;color:var(--muted);padding:4px 0;border-bottom:1px solid var(--border);">
            <span style="color:${t.color};">‚ñ∏</span> ${s.title} <span style="float:right;font-family:'Space Mono',monospace;">${s.items.length} items</span>
          </div>`).join('')}
        </div>
        <div style="display:flex;gap:8px;">
          <a href="form.html?form=${t.id}" target="_blank" class="btn btn-primary btn-sm" style="flex:1;justify-content:center;">Preview Form</a>
          <button class="btn btn-secondary btn-sm" onclick="viewTemplate('${t.id}')">üëÅÔ∏è Details</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function viewTemplate(id) {
  const t = DB.getFormTemplate(id);
  const totalItems = t.sections.reduce((sum, s) => sum + s.items.length, 0);
  let html = `<p style="color:var(--muted);margin-bottom:20px;">${t.description}</p>`;
  t.sections.forEach((sec, si) => {
    html += `<div style="margin-bottom:16px;background:var(--surface2);border-radius:10px;padding:14px;">
      <div style="font-size:12px;font-weight:700;color:${t.color};letter-spacing:1px;margin-bottom:10px;">SECTION ${si+1}: ${sec.title.toUpperCase()}</div>
      ${sec.items.map((item, ii) => `<div style="display:flex;align-items:flex-start;gap:10px;font-size:12px;padding:5px 0;border-bottom:1px solid var(--border);">
        <span style="color:var(--muted);font-family:'Space Mono',monospace;flex-shrink:0;">${si+1}.${ii+1}</span>
        <span>${item}</span>
      </div>`).join('')}
    </div>`;
  });
  UI.modal(`${t.id} ‚Äî ${t.name}`, html);
}

// ============================================================
// COMPLIANCE
// ============================================================
function renderCompliance() {
  const plants = DB.getPlants();
  const issues = DB.checkCompliance();
  const total = plants.length * 2; // daily + weekly per plant
  const passed = total - issues.length;
  const rate = total > 0 ? Math.round((passed / total) * 100) : 100;

  document.getElementById('compliance-overview').innerHTML = `
    <div style="display:flex;align-items:center;gap:24px;margin-bottom:20px;">
      <div style="text-align:center;">
        <div style="font-family:'Space Mono',monospace;font-size:48px;font-weight:700;color:${rate>=80?'#00C896':rate>=60?'#FF6B35':'#FF4757'};">${rate}%</div>
        <div style="font-size:12px;color:var(--muted);">COMPLIANCE RATE</div>
      </div>
      <div style="flex:1;">
        <div class="compliance-bar-wrap" style="height:16px;border-radius:8px;">
          <div class="compliance-bar" style="width:${rate}%;background:${rate>=80?'#00C896':rate>=60?'#FF6B35':'#FF4757'};border-radius:8px;height:100%;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;">
          <span>${passed} checks passed</span><span>${issues.length} issues found</span>
        </div>
      </div>
    </div>`;

  const table = document.getElementById('compliance-table');
  const empty = document.getElementById('compliance-empty');
  if (issues.length === 0) { table.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';
  table.innerHTML = issues.map(i => `<tr>
    <td style="font-weight:700;">${i.plantName}<br><span class="mono" style="font-size:10px;">${i.plantId}</span></td>
    <td style="font-size:13px;">${i.issue}</td>
    <td>${UI.badge(i.severity.toUpperCase(), i.severity==='warning'?'#FFB800':'#6B7A99')}</td>
    <td><a href="form.html?plant=${i.plantId}" target="_blank" class="btn btn-primary btn-sm">üìã Fill Now</a></td>
  </tr>`).join('');
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function renderNotifications() {
  const notifs = DB.getNotifications();
  const list = document.getElementById('notif-list');
  if (notifs.length === 0) {
    list.innerHTML = `<div class="empty-state"><span class="icon">üîî</span><strong>No notifications</strong><p>System alerts will appear here</p></div>`;
    return;
  }
  const icons = { info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è', success: '‚úÖ', error: 'üö®' };
  const colors = { info: '#7B61FF', warning: '#FFB800', success: '#00C896', error: '#FF4757' };
  list.innerHTML = notifs.map(n => `
    <div style="display:flex;gap:14px;padding:16px 0;border-bottom:1px solid var(--border);opacity:${n.read?0.5:1};">
      <span style="font-size:22px;">${icons[n.type] || '‚ÑπÔ∏è'}</span>
      <div style="flex:1;">
        <div style="font-weight:700;font-size:14px;color:${colors[n.type]||'var(--text)'};">${n.title}</div>
        <div style="font-size:13px;color:var(--muted);margin-top:2px;">${n.message}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;font-family:'Space Mono',monospace;">${UI.timeAgo(n.createdAt)}</div>
      </div>
      ${!n.read ? '<span style="width:8px;height:8px;background:var(--accent);border-radius:50%;margin-top:6px;flex-shrink:0;"></span>' : ''}
    </div>`).join('');
  updateNotifBadge();
}

function markAllRead() {
  DB.markAllRead();
  renderNotifications();
  UI.toast('All notifications marked as read', 'success');
}

function updateNotifBadge() {
  const count = DB.getUnreadCount();
  const b = document.getElementById('notif-badge');
  if (count > 0) { b.style.display = ''; b.textContent = count; } else { b.style.display = 'none'; }
}

// ============================================================
// SETTINGS
// ============================================================
function renderSettings() {
  const s = DB.getSettings();
  document.getElementById('set-company').value = s.companyName || '';
  document.getElementById('set-site').value = s.siteName || '';
  document.getElementById('set-manager').value = s.siteManager || '';
  document.getElementById('set-safety').value = s.safetyOfficer || '';
  document.getElementById('set-email').value = s.notifyEmail || '';
  document.getElementById('set-daily').value = s.dailyFormRequired || 'GA2';
  document.getElementById('set-weekly').value = s.weeklyFormRequired || 'GA3';
}

function saveSettings() {
  const s = {
    companyName: document.getElementById('set-company').value,
    siteName: document.getElementById('set-site').value,
    siteManager: document.getElementById('set-manager').value,
    safetyOfficer: document.getElementById('set-safety').value,
    notifyEmail: document.getElementById('set-email').value,
    dailyFormRequired: document.getElementById('set-daily').value,
    weeklyFormRequired: document.getElementById('set-weekly').value,
  };
  DB.saveSettings(s);
  updateSidebarInfo();
  UI.toast('Settings saved!', 'success');
}

function updateSidebarInfo() {
  const s = DB.getSettings();
  document.getElementById('site-name-display').textContent = s.siteName || 'Site Name';
  document.getElementById('company-display').textContent = s.companyName || 'Company Name';
}

function exportData() {
  const data = {
    plants: DB.getPlants(),
    submissions: DB.getSubmissions(),
    settings: DB.getSettings(),
    formTemplates: DB.getFormTemplates(),
    exportedAt: new Date().toISOString(),
    version: '1.0'
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ga-forms-export-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  UI.toast('Data exported successfully', 'success');
}

function importDataPrompt() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (data.plants) DB.set('plants', data.plants);
        if (data.submissions) DB.set('submissions', data.submissions);
        if (data.settings) DB.set('settings', data.settings);
        if (data.formTemplates) DB.set('formTemplates', data.formTemplates);
        UI.toast('Data imported successfully! Refreshing...', 'success');
        setTimeout(() => location.reload(), 1500);
      } catch { UI.toast('Invalid file format', 'error'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

function resetData() {
  UI.confirm('This will delete ALL plants, submissions and settings. This cannot be undone. Are you absolutely sure?', () => {
    localStorage.clear();
    UI.toast('All data reset. Reloading...', 'warning');
    setTimeout(() => location.reload(), 1500);
  });
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  // Date
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
  
  // Seed data
  DB.getPlants();
  DB.getFormTemplates();
  
  // Update sidebar
  updateSidebarInfo();
  
  // Generate initial notifications if none
  if (DB.getNotifications().length === 0) {
    DB.addNotification({ title: 'System Ready', message: 'GA Forms System initialized successfully. Add plants and start inspecting!', type: 'success' });
    DB.addNotification({ title: 'Welcome', message: 'Scan plant QR codes from the field to fill inspection forms directly on mobile.', type: 'info' });
    const issues = DB.checkCompliance();
    issues.slice(0, 3).forEach(i => DB.addNotification({ title: 'Compliance Alert', message: `${i.plantName}: ${i.issue}`, type: 'warning' }));
  }
  
  // Badges
  updateNotifBadge();
  const issues = DB.checkCompliance();
  const b = document.getElementById('issues-badge');
  if (issues.length > 0) { b.style.display = ''; b.textContent = issues.length; }
  
  renderDashboard();
});
</script>
</body>
</html>
